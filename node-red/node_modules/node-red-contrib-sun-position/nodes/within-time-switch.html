<script type="text/x-red" data-template-name="within-time-switch">
    <div class="form-row block-noindent" data-i18n="[title]node-red-contrib-sun-position/position-config:common.placeholder.positionConfig">
        <label for="node-input-positionConfig"><i class="fa fa-globe"></i> <span data-i18n="node-red-contrib-sun-position/position-config:common.label.positionConfig"></span></label>
        <input type="text" id="node-input-positionConfig">
    </div>
    <hr>
    <div class="form-row block-noindent is-to-show-initially" id="node-input-startTime-div" data-i18n="[titleOrg]within-time-switch.placeholder.startTime">
        <label for="node-input-startTime"><i class="fa fa-clock-o"></i> <span data-i18n="within-time-switch.label.startTime"></span></label>
        <input type="text" id="node-input-startTime" />
        <input type="hidden" id="node-input-startTimeType">
    </div>
    <div class="form-row block-indent1 is-to-show-initially" data-i18n="[title]within-time-switch.placeholder.startOffset">
        <label for="node-input-startOffset"><i class="fa fa-calculator"></i> <span data-i18n="within-time-switch.label.startOffset"></span></label>
        <input id="node-input-startOffset" data-i18n="[placeholder]within-time-switch.placeholder.startOffset"></input>
        <input type="hidden" id="node-input-startOffsetType">
        <select id="node-input-startOffsetMultiplier" class="node-input-multiplier"></select>
    </div>

    <div class="form-row block-noindent is-to-show-initially" id="node-input-endTime-div" data-i18n="[titleOrg]within-time-switch.placeholder.endTime">
        <label for="node-input-endTime"><i class="fa fa-clock-o"></i> <span data-i18n="within-time-switch.label.endTime"></span></label>
        <input type="text" id="node-input-endTime" data-i18n="[placeholder]within-time-switch.label.endTime"/>
        <input type="hidden" id="node-input-endTimeType">
    </div>
    <div class="form-row block-indent1 is-to-show-initially" data-i18n="[title]within-time-switch.placeholder.endOffset">
        <label for="node-input-endOffset"><i class="fa fa-calculator"></i> <span data-i18n="within-time-switch.label.endOffset"></span></label>
        <input id="node-input-endOffset" data-i18n="[placeholder]within-time-switch.placeholder.endOffset"></input>
        <input type="hidden" id="node-input-endOffsetType">
        <select id="node-input-endOffsetMultiplier" class="node-input-multiplier"></select>
    </div>
    <hr>
    <div class="form-row form-tips is-to-show-initially" data-i18n="[html]within-time-switch.tips.addTimes"></div>
    <div class="form-row alternate-property-start is-to-show-initially" data-i18n="[title]within-time-switch.placeholder.propertyStart">
        <label for="node-input-propertyStart"><i class="fa fa-sun-o"></i> <span data-i18n="within-time-switch.label.propertyStart"></span></label>
        <input type="text" id="node-input-propertyStart" data-i18n="[placeholder]within-time-switch.placeholder.propertyStart"/>
        <input type="hidden" id="node-input-propertyStartType">
        <select id="node-input-propertyStartCompare" class="node-input-addOn">
        </select>
    </div>
    <div class="form-row block-indent2 row-propertyStartThreshold is-initial-hidden" data-i18n="[title]within-time-switch.placeholder.propertyStartThreshold">
        <label for="node-input-propertyStartThreshold"><i class="fa fa-compress"></i> <span data-i18n="within-time-switch.label.propertyStartThreshold"></span></label>
        <input type="text" id="node-input-propertyStartThreshold" data-i18n="[placeholder]within-time-switch.placeholder.propertyStartThreshold">
        <input type="hidden" id="node-input-propertyStartThresholdType">
    </div>
    <div class="form-row block-indent1 alternate-time-start is-initial-hidden" id="node-input-startTimeAlt-div" data-i18n="[titleOrg]within-time-switch.placeholder.startTimeAlt">
        <label for="node-input-startTimeAlt"><i class="fa fa-clock-o"></i> <span data-i18n="within-time-switch.label.startTimeAlt"></span></label>
        <input type="text" id="node-input-startTimeAlt" data-i18n="[placeholder]within-time-switch.placeholder.startTimeAlt"/>
        <input type="hidden" id="node-input-startTimeAltType">
    </div>
    <div class="form-row block-indent1 alternate-time-start-offset is-initial-hidden" data-i18n="[title]within-time-switch.placeholder.startTimeAltOffset">
        <label for="node-input-startTimeAltOffset"><i class="fa fa-calculator"></i> <span data-i18n="within-time-switch.label.startTimeAltOffset"></span></label>
        <input id="node-input-startTimeAltOffset" data-i18n="[placeholder]within-time-switch.placeholder.startTimeAltOffset"></input>
        <input type="hidden" id="node-input-startTimeAltOffsetType">
        <select id="node-input-startTimeAltOffsetMultiplier" class="node-input-multiplier"></select>
    </div>
    <div class="form-row alternate-property-end is-to-show-initially" data-i18n="[title]within-time-switch.placeholder.propertyEnd">
        <label for="node-input-propertyEnd"><i class="fa fa-sun-o"></i> <span data-i18n="within-time-switch.label.propertyEnd"></span></label>
        <input type="text" id="node-input-propertyEnd" data-i18n="[placeholder]within-time-switch.placeholder.propertyEnd"/>
        <input type="hidden" id="node-input-propertyEndType">
        <select id="node-input-propertyEndCompare" class="node-input-addOn">
        </select>
    </div>
    <div class="form-row block-indent2 row-propertyEndThreshold is-initial-hidden" data-i18n="[title]within-time-switch.placeholder.propertyEndThreshold">
        <label for="node-input-propertyEndThreshold"><i class="fa fa-compress"></i> <span data-i18n="within-time-switch.label.propertyEndThreshold"></span></label>
        <input type="text" id="node-input-propertyEndThreshold" data-i18n="[placeholder]within-time-switch.placeholder.propertyEndThreshold">
        <input type="hidden" id="node-input-propertyEndThresholdType">
    </div>
    <div class="form-row block-indent1 alternate-time-end is-initial-hidden" id="node-input-endTimeAlt-div" data-i18n="[titleOrg]within-time-switch.placeholder.endTimeAlt">
        <label for="node-input-endTimeAlt"><i class="fa fa-clock-o"></i> <span data-i18n="within-time-switch.label.endTimeAlt"></span></label>
        <input type="text" id="node-input-endTimeAlt" data-i18n="[placeholder]within-time-switch.placeholder.endTimeAlt"/>
        <input type="hidden" id="node-input-endTimeAltType">
    </div>
    <div class="form-row block-indent1 alternate-time-end-offset is-initial-hidden" data-i18n="[title]within-time-switch.placeholder.endTimeAltOffset">
        <label for="node-input-endTimeAltOffset"><i class="fa fa-calculator"></i> <span data-i18n="within-time-switch.label.endTimeAltOffset"></span></label>
        <input id="node-input-endTimeAltOffset" data-i18n="[placeholder]within-time-switch.placeholder.endTimeAltOffset"></input>
        <input type="hidden" id="node-input-endTimeAltOffsetType">
        <select id="node-input-endTimeAltOffsetMultiplier" class="node-input-multiplier"></select>
    </div>
    <hr>
    <div class="form-row is-to-show-initially">
        <a href="#" class="enhanced-row-toggle"><span data-i18n="within-time-switch.label.showEnhSettings"></span></a>
    </div>
    <div class="form-row enhanced-row" style="display:none">
        <div class="form-row compare-row" data-i18n="[title]within-time-switch.placeholder.compareTime">
            <label for="node-input-tsCompare"><i class="fa fa-clock-o"></i> <span data-i18n="within-time-switch.label.compareTime"></span></label>
            <select id="node-input-tsCompare" style="width:70%;" >
                <option value="0" data-i18n="within-time-switch.label.now"></option>
                <option value="1" data-i18n="within-time-switch.label.msgts"></option>
                <option value="2" data-i18n="within-time-switch.label.msglc"></option>
                <option value="3" data-i18n="within-time-switch.label.msgtime"></option>
                <option value="4" data-i18n="within-time-switch.label.msgvalue"></option>
            </select>
        </div>
        <div class="form-row msg-start-out-row" data-i18n="[title]within-time-switch.placeholder.lastMsgOnStartOut">
            <label for="node-input-lastMsgOnStartOut"><i class="fa fa-forward"></i> <span data-i18n="within-time-switch.label.lastMsgOnStartOut"></span></label>
            <input type="checkbox" id="node-input-lastMsgOnStartOut" style="display:inline-block; width:15px; vertical-align:baseline;">
            <span data-i18n="within-time-switch.label.lastMsgOnStartOutTxt"></span>
        </div>
        <div class="form-row msg-end-out-row" data-i18n="[title]within-time-switch.placeholder.lastMsgOnEndOut">
            <label for="node-input-lastMsgOnEndOut"><i class="fa fa-fast-forward"></i> <span data-i18n="within-time-switch.label.lastMsgOnEndOut"></span></label>
            <input type="checkbox" id="node-input-lastMsgOnEndOut" style="display:inline-block; width:15px; vertical-align:baseline;">
            <span data-i18n="within-time-switch.label.lastMsgOnEndOutTxt"></span>
        </div>
    </div>
    <hr>
    <div class="form-row block-noindent" data-i18n="[title]node-red:common.label.name">
        <label for="node-input-name"><i class="icon-tag"></i> <span data-i18n="node-red:common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]node-red:common.label.name">
    </div>
</script>
<style>
    hr {
        width: 100%
    }
    .is-to-show-initially {
        display:none
    }
    .is-initial-hidden {
        display:none
    }
    .form-tips {
        width: 90%
    }
    .block-indent1 {
        float: left;
        min-height: 1px;
        margin-left: 10px;
        width: calc(100% - 15px);
    }
    .block-indent2 {
        float: left;
        min-height: 1px;
        margin-left: 20px;
        width: calc(100% - 25px);
    }
    .block-noindent .row-full-width {
        width : calc(100% - 115px);
    }
    .block-indent1 .row-full-width {
        width : calc(100% - 125px);
    }
    .block-indent2 .row-full-width {
        width : calc(100% - 135px);
    }
    .block-noindent .ui-spinner {
        width : calc(100% - 250px);
    }
    .block-indent1 .ui-spinner {
        width : calc(100% - 260px);
    }
    .block-indent2 .ui-spinner {
        width : calc(100% - 270px);
    }
    .node-input-multiplier {
        width: 125px;
        max-width: 125px;
        margin-left: 5px;
    }
    .node-input-addOn {
        width: 100px;
        max-width: 100px;
        margin-left: 5px;
    }
</style>

<script type="text/javascript">
    function clipValueLength(v, l) {
        l = l || 18;
        return (v.length > l) ? v.slice(0, (l - 3)) + '...' : v;
    }

    function getValueLabel(node, t, v, offset, l) {
        l = l || 20;
        let suffix = '';
        if (offset && offset > 0) {
            suffix = '↷';
        } else if (offset && offset < 0) {
            suffix = '↶';
        }

        if (t === 'jsonata') {
            if (v.length < l) { return v + suffix; }
            return node._('node-red-contrib-sun-position/position-config:common.label.jsonata') + suffix;
        }

        if (t === 'json') {
            if (v.length < l) { return  v + suffix; }
            return node._('node-red-contrib-sun-position/position-config:common.label.json') + suffix;
        }

        if (t === 'bin') {
            return node._('node-red-contrib-sun-position/position-config:common.label.binary') + suffix;
        }

        if (t === 'date') {
            return node._('node-red-contrib-sun-position/position-config:common.label.timestamp') + suffix;
        }

        if (t === 'dateSpecific') {
            return node._('node-red-contrib-sun-position/position-config:common.label.timestamp') + '+' + suffix;
        }

        if (t === 'string' || t === 'str' || t === 'DayOfMonth') {
            if (v === '') { return node._('node-red-contrib-sun-position/position-config:common.label.blank') + suffix; }
            return '"' + clipValueLength(v, l) + '"' + suffix;
        }

        if (t === 'num') {
            if (v === '') { return '0' + suffix; }
            return String(v) + suffix;
        }

        if (t === 'bool') {
            if (v === '') { return 'false' + suffix; }
            return String(v) + suffix;
        }

        if (t === 'msg') {
            return t + '.' + clipValueLength(v, l) + suffix;
        }

        if (t === 'flow' || t === 'global') {
            const result = RED.utils.parseContextKey(v);
            return t + '.' + clipValueLength(result.key, l) + suffix;
        }

        if (t === 'pdsCalcData') {
            return '{sun position}' + suffix;
        }

        if (t === 'pdmCalcData') {
            return '{moon position}' + suffix;
        }

        if (t === 'pdsTime') {
            const res = v.replace('astronomical', 'astro-').replace('nautical', 'naut-').replace('amateur', 'amat-').replace('blueHour', 'blueHr-').replace('goldenHour', 'goldHr-');
            return clipValueLength(res, l) + suffix;
        }

        if (t === 'pdmTime') {
            return 'moon' + v + suffix;
        }

        if (t === 'msgPayload') { return 'msg.payload'; }
        if (t === 'msgTs') { return 'msg.ts'; }
        if (t === 'msgLc') { return 'msg.lc'; }
        if (t === 'msgValue') { return 'msg.value'; }

        if (v === '') {
            return node._('node-red-contrib-sun-position/position-config:common.label.blank');
        }

        return clipValueLength(v, l) + suffix;
    }

    RED.nodes.registerType('within-time-switch', {
        category: 'time and astro',
        color: '#f37a33',
        icon: 'switch-white.png',
        inputs: 1,
        outputs: 2,
        defaults: {
            name: {
                value: '',
                required: false
            },
            positionConfig: {
                value: '',
                type: 'position-config',
                required: true
            },
            startTime: {
                value: '',
                required: true,
                validate: RED.validators.typedInput('startTimeType')
            },
            startTimeType: {
                value: 'entered'
            },
            startOffset: {
                value: 0,
                validate: (v) => {
                    return (
                        (typeof v === 'undefined') ||
                        (typeof this.startOffsetType === 'undefined') ||
                        RED.validators.typedInput('startOffsetType')(v)
                    );
                }
            },
            startOffsetType: {
                value: 'none'
            },
            startOffsetMultiplier: {
                value: 60000,
                required: true,
                validate: RED.validators.number()
            },
            endTime: {
                value: '',
                required: true,
                validate: RED.validators.typedInput('endTimeType')
            },
            endTimeType: {
                value: 'entered'
            },
            endOffset: {
                value: 0,
                validate: (v) => {
                    return (
                        (typeof v === 'undefined') ||
                        (typeof this.endOffsetType === 'undefined') ||
                        RED.validators.typedInput('endOffsetType')(v)
                    );
                }
            },
            endOffsetType: {
                value: 'none'
            },
            endOffsetMultiplier: {
                value: 60000,
                required: true,
                validate: RED.validators.number()
            },
            propertyStart: {
                value: '',
                required: false,
                validate: RED.validators.typedInput('propertyStartType')
            },
            propertyStartType: {
                value: 'none'
            },
            propertyStartCompare: {
                value: 'true'
            },
            propertyStartThreshold: {
                value: '',
                validate: function (v) {
                    return (
                        typeof v === 'undefined' ||
                        RED.validators.typedInput('propertyStartThresholdType')(v) ||
                        ($('#node-input-startTimeAltType').length ?
                            $('#node-input-startTimeAlt').typedInput('type') === 'none' :
                            this.startTimeAlt === 'none') ||
                        typeof this.propertyStartType === 'undefined' ||
                        ($('#node-input-propertyStartType').length ?
                            $('#node-input-propertyStart').typedInput('type') === 'none' :
                            this.propertyStartType === 'none')
                    );
                }
            },
            propertyStartThresholdType: {
                value: 'num'
            },
            startTimeAlt: {
                value: '',
                required: false,
                validate: (v) => {
                    return RED.validators.typedInput('startTimeAltType')(v) || ($(
                        '#node-input-propertyStart').typedInput(
                        'type') === 'none');
                }
            },
            startTimeAltType: {
                value: 'none'
            },
            startOffsetAlt: {
                value: 0,
                validate: (v) => {
                    return (
                        (typeof v === 'undefined') ||
                        (typeof this.startOffsetAltType === 'undefined') ||
                        RED.validators.typedInput('startOffsetAltType')(v) ||
                        ($('#node-input-propertyStart').typedInput('type') === 'none') ||
                        ($('#node-input-startTimeAlt').typedInput('type') === 'none')
                    );
                }
            },
            startOffsetAltType: {
                value: 'none'
            },
            startOffsetAltMultiplier: {
                value: 60000,
                required: true,
                validate: (v) => {
                    return RED.validators.number()(v) ||
                    ($('#node-input-propertyStart').typedInput('type') === 'none') ||
                    ($('#node-input-startTimeAlt').typedInput('type') === 'none');
                }
            },
            propertyEnd: {
                value: '',
                required: false,
                validate: RED.validators.typedInput('propertyEndType')
            },
            propertyEndType: {
                value: 'none'
            },
            propertyEndCompare: {
                value: 'true'
            },
            propertyEndThreshold: {
                value: '',
                validate: function (v) {
                    return (
                        typeof v === 'undefined' ||
                        RED.validators.typedInput('propertyEndThresholdType')(v) ||
                        ($('#node-input-startTimeAltType').length ?
                            $('#node-input-startTimeAlt').typedInput('type') === 'none' :
                            this.startTimeAlt === 'none') ||
                        typeof this.propertyEndType === 'undefined' ||
                        ($('#node-input-propertyEndType').length ?
                            $('#node-input-propertyEnd').typedInput('type') === 'none' :
                            this.propertyEndType === 'none')
                    );
                }
            },
            propertyEndThresholdType: {
                value: 'num'
            },
            endTimeAlt: {
                value: '',
                required: false,
                validate: (v) => {
                    return RED.validators.typedInput('endTimeAltType')(v) || ($('#node-input-propertyEnd').typedInput(
                        'type') === 'none');
                }
            },
            endTimeAltType: {
                value: 'none'
            },
            endOffsetAlt: {
                value: 0,
                validate: (v) => {
                    return (
                        (typeof v === 'undefined') ||
                        (typeof this.startOffsetAltType === 'undefined') ||
                        RED.validators.typedInput('startOffsetAltType')(v) ||
                        ($('#node-input-propertyEnd').typedInput('type') === 'none') ||
                        ($('#node-input-endTimeAlt').typedInput('type') === 'none')
                    );
                }
            },
            endOffsetAltType: {
                value: 'none'
            },
            endOffsetAltMultiplier: {
                value: 60000,
                required: true,
                validate: (v) => {
                    return RED.validators.number()(v) ||
                    ($('#node-input-propertyEnd').typedInput('type') === 'none') ||
                    ($('#node-input-endTimeAlt').typedInput('type') === 'none');
                }
            },
            tsCompare: {
                value: '0'
            },
            lastMsgOnStartOut: {
                value: false,
                required: false
            },
            lastMsgOnEndOut: {
                value: false,
                required: false
            }
        },
        outputLabels: ['within time', 'out of time'],
        label() {
            const getConcatId = (type1, value1, offset1, property, type2, value2, offset2) => {
                if (property !== 'none' && property !== '' && value2) {
                    return getValueLabel(this, type1, value1, offset1, 12) + '/' + getValueLabel(this, type2, value2, offset2, 12);
                }

                return getValueLabel(this, type1, value1, undefined, 12);
            };

            if (this.name) {
                return this.name;
            }

            if (this.startTime && this.endTime) {
                return getConcatId(this.startTimeType, this.startTime, this.startOffset, this.propertyStartType,
                    this.startTimeAltType, this.startTimeAlt, this.startOffsetAlt) +
            ((this.lastMsgOnStartOut) ? '⨧ - ' : ' - ') +
            getConcatId(this.endTimeType, this.endTime, this.endOffset, this.propertyEndType,
                this.endTimeAltType, this.endTimeAlt, this.endTimeAltOffset) +
            ((this.lastMsgOnEndOut) ? '⨧' : '');
            }

            return 'within-time';
        },
        labelStyle() {
            return this.name ? 'node_label_italic' : '';
        },
        paletteLabel: 'within-time',
        align: 'left',
        oneditprepare() {
            setTimeout(() => {
                $('.is-to-show-initially').show();
                $('.is-to-hide-initially').hide();
            }, 300);

            $('.enhanced-row-toggle').on('click', () => {
                $('.enhanced-row').toggle(); // .hide();
            });

            const node = this;
            const $nodeConfig = $('#node-input-positionConfig');
            const setup = function(node) {
                /* global getTypes getSelectFields appendOptions setupTInput initializeValue getTimeData */

                const types = getTypes(node);
                const selFields = getSelectFields();
                // #region initialize
                function multiplierUpdate(mp, name) {
                    const field = $('#node-input-' + name);
                    appendOptions(node, field, 'multiplier', (data) => (data.id > 0));
                    if (mp === null || typeof mp === 'undefined' || isNaN(mp) || mp === '' || mp === 0) {
                        mp = 60000;
                    } else {
                        mp = parseFloat(mp);
                        if (mp === 1) {
                            mp = 1000;
                        } else if (mp === 60) {
                            mp = 60000;
                        } else if (mp === 3600) {
                            mp = 3600000;
                        }
                    }
                    field.val(mp);
                    return mp;
                }
                // #endregion initialize
                // #region timeStart
                const $startTime = setupTInput(node, {
                    typeProp: 'startTimeType',
                    valueProp: 'startTime',
                    width: 'calc(100% - 110px)',
                    defaultType: node.startTimeType || types.TimeEntered.value,
                    defaultValue: node.startTime || '',
                    types: [types.TimeEntered, types.TimeSun, types.TimeMoon,  'msg', 'flow', 'global', 'env'],
                    onFocus: (_type, _value) => {
                        const plVType = $('#node-input-startTime').typedInput('type');
                        const plVTypeAlt = $('#node-input-startTimeAlt').typedInput('type');
                        if (plVType ===  'msg' ||
                            plVType === 'flow' ||
                            plVType === 'global' ||
                            plVTypeAlt === 'msg' ||
                            plVTypeAlt === 'flow' ||
                            plVTypeAlt === 'global') {
                            $('.msg-start-out-row').hide();
                        } else {
                            $('.msg-start-out-row').show();
                        }
                    },
                    onChange: (_type, _value) => {
                        getTimeData(d => {
                            const $div = $('#node-input-startTime-div');
                            const titleOrg = $div.attr('titleOrg');
                            if (d.value) {
                                const dv = new Date(d.value);
                                $div.attr('title', dv.toLocaleTimeString() + ' (' + dv.toISOString() + ') - ' + titleOrg);
                            } else {
                                $div.attr('title', titleOrg);
                            }
                        }, {
                            config:     $nodeConfig.val(),
                            type:       $('#node-input-startTime').typedInput('type'),
                            value:      $('#node-input-startTime').typedInput('value'),
                            offsetType: $('#node-input-startOffset').typedInput('type'),
                            offset:     $('#node-input-startOffset').typedInput('value'),
                            multiplier: $('#node-input-startOffsetMultiplier').val()
                        });
                    }
                });

                node.startOffsetMultiplier = multiplierUpdate(node.startOffsetMultiplier, 'startOffsetMultiplier');
                setupTInput(node, {
                    typeProp: 'startOffsetType',
                    valueProp: 'startOffset',
                    width: 'calc(100% - 255px)',
                    defaultType: (node.startOffset === 0 || node.startOffset === '') ? types.Undefined.value : 'num',
                    defaultValue: 0,
                    types: [types.Undefined, 'num', 'msg', 'flow', 'global', 'env'],
                    onChange: (_type, _value) => {
                        const type = $('#node-input-startOffset').typedInput('type');
                        if (type === types.Undefined.value) {
                            $('#node-input-startOffsetMultiplier').prop('disabled', true);
                        } else {
                            $('#node-input-startOffsetMultiplier').prop('disabled', false);
                        }
                    }
                }).change();
                // #endregion timeStart
                // #region timeEnd
                const $endTime = setupTInput(node, {
                    typeProp: 'endTimeType',
                    valueProp: 'endTime',
                    width: 'calc(100% - 110px)',
                    defaultType: node.endTimeType || types.TimeEntered.value,
                    defaultValue: node.endTime || '',
                    types: [types.TimeEntered, types.TimeSun, types.TimeMoon,  'msg', 'flow', 'global', 'env'],
                    onFocus: (_type, _value) => {
                        const plVType = $('#node-input-endTime').typedInput('type');
                        const plVTypeAlt = $('#node-input-endTimeAlt').typedInput('type');
                        if (plVType ===  'msg' ||
                            plVType === 'flow' ||
                            plVType === 'global' ||
                            plVTypeAlt === 'msg' ||
                            plVTypeAlt === 'flow' ||
                            plVTypeAlt === 'global') {
                            $('.msg-end-out-row').hide();
                        } else {
                            $('.msg-end-out-row').show();
                        }
                    },
                    onChange: (_type, _value) => {
                        getTimeData(d => {
                            const $div = $('#node-input-endTime-div');
                            const titleOrg = $div.attr('titleOrg');
                            if (d.value) {
                                const dv = new Date(d.value);
                                $div.attr('title', dv.toLocaleTimeString() + ' (' + dv.toISOString() + ') - ' + titleOrg);
                            } else {
                                $div.attr('title', titleOrg);
                            }
                        }, {
                            config:     $nodeConfig.val(),
                            type:       $('#node-input-endTime').typedInput('type'),
                            value:      $('#node-input-endTime').typedInput('value'),
                            offsetType: $('#node-input-endOffset').typedInput('type'),
                            offset:     $('#node-input-endOffset').typedInput('value'),
                            multiplier: $('#node-input-endOffsetMultiplier').val()
                        });
                    }
                });

                node.endOffsetMultiplier = multiplierUpdate(node.endOffsetMultiplier, 'endOffsetMultiplier');
                setupTInput(node, {
                    typeProp: 'endOffsetType',
                    valueProp: 'endOffset',
                    width: 'calc(100% - 255px)',
                    defaultType: (node.endOffset === 0 || node.endOffset === '') ? types.Undefined.value : 'num',
                    defaultValue: 0,
                    types: [types.Undefined, 'num', 'msg', 'flow', 'global', 'env'],
                    onChange: (_type, _value) => {
                        const type = $('#node-input-endOffset').typedInput('type');
                        if (type === types.Undefined.value) {
                            $('#node-input-endOffsetMultiplier').prop('disabled', true);
                        } else {
                            $('#node-input-endOffsetMultiplier').prop('disabled', false);
                        }
                    }
                }).change();
                // #endregion timeEnd
                // #region propertyStart
                const $propertyStart = setupTInput(node, {
                    typeProp: 'propertyStartType',
                    valueProp: 'propertyStart',
                    width: 'calc(100% - 110px)',
                    defaultType: node.propertyStartType  || types.Undefined.value,
                    defaultValue: node.propertyStartValue || '' ,
                    types: [types.Undefined, 'msg', 'flow', 'global', 'jsonata', 'env'],
                    onChange: (_type, _value) => {
                        const propCompare = $('#node-input-propertyStartCompare');
                        const propType = $('#node-input-propertyStart').typedInput('type');
                        if (propType === 'none') {
                            $('.alternate-time-start').hide();
                            $('.alternate-time-start-offset').hide();
                            propCompare.hide();
                            $('.row-propertyStartThreshold').hide();
                            $('#node-input-propertyStart').typedInput('width', 'calc(100% - 110px)');
                        } else if (propType === 'jsonata') {
                            $('.alternate-time-start').show();
                            propCompare.show();
                            propCompare.attr('disabled', true);
                            propCompare.val(selFields.comparator[0].id); // only true is valid for jsonata
                            $('.row-propertyStartThreshold').hide();
                            $('#node-input-propertyStart').typedInput('width', 'calc(100% - 220px)');
                        } else {
                            $('.alternate-time-start').show();
                            propCompare.show();
                            propCompare.attr('disabled', false);
                            $('#node-input-propertyStart').typedInput('width', 'calc(100% - 220px)');
                            const condOp = propCompare.val();
                            let operatorCount = 1;
                            const fields = selFields.comparator;
                            const fieldsLength = fields.length;
                            for (let index = 0; index < fieldsLength; index++) {
                                const el = fields[index];
                                if (el.id === condOp) {
                                    operatorCount = el.operatorCount;
                                    break;
                                }
                            }
                            if (operatorCount > 1) {
                                $('.row-propertyStartThreshold').show(); // condOpB
                            } else {
                                $('.row-propertyStartThreshold').hide(); // condOpB
                            }
                        }
                        $('#node-input-startTimeAlt').change();
                        $('#node-input-propertyStartThreshold').change();
                    }
                });
                const $propertyStartCompare = $('#node-input-propertyStartCompare');
                appendOptions(node, $propertyStartCompare, 'comparator');
                $propertyStartCompare.val(node.propertyStartCompare || 'true');
                $propertyStartCompare.change(() => { $('#node-input-propertyStart').change(); });
                setupTInput(node, {
                    typeProp: 'propertyStartThresholdType',
                    valueProp: 'propertyStartThreshold',
                    width: 'calc(100% - 130px)',
                    defaultType: 'num',
                    defaultValue: '',
                    types: ['msg', 'flow', 'global', 'str', 'num', 'env']
                });
                // #endregion propertyStart
                // #region timeAltStart
                setupTInput(node, {
                    typeProp: 'startTimeAltType',
                    valueProp: 'startTimeAlt',
                    width: 'calc(100% - 110px)',
                    defaultType: 'entered',
                    defaultValue: '',
                    types: [types.TimeEntered, types.TimeSun, types.TimeMoon, 'flow', 'global', 'env'],
                    onFocus: (_type, _value) => {
                        if (($('#node-input-startTimeAlt').typedInput('type') === 'none') ||
                            ($('#node-input-propertyStart').typedInput('type') === 'none')) {
                            $('.alternate-time-start-offset').hide();
                        } else {
                            $('.alternate-time-start-offset').show();
                        }
                    },
                    onChange: (_type, _value) => {
                        console.log('startTimeAlt');
                        getTimeData(d => {
                            console.log(d);
                            const $div = $('#node-input-startTimeAlt-div');
                            const titleOrg = $div.attr('titleOrg');
                            if (d.value) {
                                const dv = new Date(d.value);
                                $div.attr('title', dv.toLocaleTimeString() + ' (' + dv.toISOString() + ') - ' + titleOrg);
                            } else {
                                $div.attr('title', titleOrg);
                            }
                        }, {
                            config:     $nodeConfig.val(),
                            type:       $('#node-input-startTimeAlt').typedInput('type'),
                            value:      $('#node-input-startTimeAlt').typedInput('value'),
                            offsetType: $('#node-input-startTimeAltOffset').typedInput('type'),
                            offset:     $('#node-input-startTimeAltOffset').typedInput('value'),
                            multiplier: $('#node-input-startTimeAltOffsetMultiplier').val()
                        });
                    }
                });

                node.startTimeAltOffsetMultiplier = multiplierUpdate(node.startTimeAltOffsetMultiplier, 'startTimeAltOffsetMultiplier');
                setupTInput(node, {
                    typeProp: 'startTimeAltOffsetType',
                    valueProp: 'startTimeAltOffset',
                    width: 'calc(100% - 255px)',
                    defaultType: (node.startTimeAltOffset === 0 || node.startTimeAltOffset === '') ? types.Undefined.value : 'num',
                    defaultValue: 0,
                    types: [types.Undefined, 'num', 'flow', 'global', 'env'],
                    onChange: (_type, _value) => {
                        const type = $('#node-input-startTimeAltOffset').typedInput('type');
                        if (type === types.Undefined.value) {
                            $('#node-input-startTimeAltOffsetMultiplier').prop('disabled', true);
                        } else {
                            $('#node-input-startTimeAltOffsetMultiplier').prop('disabled', false);
                        }
                    }
                }).change();
                // #endregion timeAltStart
                // #region propertyEnd
                const $propertyEnd = setupTInput(node, {
                    typeProp: 'propertyEndType',
                    valueProp: 'propertyEnd',
                    width: 'calc(100% - 110px)',
                    defaultType: node.propertyEndType  || types.Undefined.value,
                    defaultValue: node.propertyEndValue || '' ,
                    types: [types.Undefined, 'msg', 'flow', 'global', 'jsonata', 'env'],
                    onChange: (_type, _value) => {
                        const propCompare = $('#node-input-propertyEndCompare');
                        const propType = $('#node-input-propertyEnd').typedInput('type');

                        if (propType === 'none') {
                            $('.alternate-time-end').hide();
                            $('.alternate-time-end-offset').hide();
                            propCompare.hide();
                            $('.row-propertyEndThreshold').hide();
                            $('#node-input-propertyEnd').typedInput('width', 'calc(100% - 110px)');
                        } else if (propType === 'jsonata') {
                            $('.alternate-time-end').show();
                            propCompare.show();
                            propCompare.attr('disabled', true);
                            propCompare.val(selFields.comparator[0].id); // only true is valid for jsonata
                            $('.row-propertyEndThreshold').hide();
                            $('#node-input-propertyEnd').typedInput('width', 'calc(100% - 220px)');
                        } else {
                            $('.alternate-time-end').show();
                            propCompare.show();
                            propCompare.attr('disabled', false);
                            $('#node-input-propertyEnd').typedInput('width', 'calc(100% - 220px)');
                            const condOp = propCompare.val();
                            let operatorCount = 1;
                            const fields = selFields.comparator;
                            const fieldsLength = fields.length;
                            for (let index = 0; index < fieldsLength; index++) {
                                const el = fields[index];
                                if (el.id === condOp) {
                                    operatorCount = el.operatorCount;
                                    break;
                                }
                            }
                            if (operatorCount > 1) {
                                $('.row-propertyEndThreshold').show(); // condOpB
                            } else {
                                $('.row-propertyEndThreshold').hide(); // condOpB
                            }
                        }
                        $('#node-input-endTimeAlt').change();
                        $('#node-input-propertyEndThreshold').change();
                    }
                });
                const $propertyEndCompare = $('#node-input-propertyEndCompare');
                appendOptions(node, $propertyEndCompare, 'comparator');
                $propertyEndCompare.val(node.propertyEndCompare || 'true');
                $propertyEndCompare.change(() => { $('#node-input-propertyEnd').change(); });
                setupTInput(node, {
                    typeProp: 'propertyEndThresholdType',
                    valueProp: 'propertyEndThreshold',
                    width: 'calc(100% - 130px)',
                    defaultType: 'num',
                    defaultValue: '',
                    types: ['msg', 'flow', 'global', 'str', 'num', 'env']
                });
                // #endregion propertyEnd
                // #region timeAltEnd
                setupTInput(node, {
                    typeProp: 'endTimeAltType',
                    valueProp: 'endTimeAlt',
                    width: 'calc(100% - 110px)',
                    defaultType: 'entered',
                    defaultValue: '',
                    types: [types.TimeEntered, types.TimeSun, types.TimeMoon, 'flow', 'global', 'env'],
                    onFocus: (_type, _value) => {
                        if (($('#node-input-startTimeAlt').typedInput('type') === 'none') ||
                            ($('#node-input-propertyStart').typedInput('type') === 'none')) {
                            $('.alternate-time-start-offset').hide();
                        } else {
                            $('.alternate-time-start-offset').show();
                        }
                    },
                    onChange: (_type, _value) => {
                        console.log('endTimeAlt');
                        getTimeData(d => {
                            console.log(d);
                            const $div = $('#node-input-endTimeAlt-div');
                            const titleOrg = $div.attr('titleOrg');
                            if (d.value) {
                                const dv = new Date(d.value);
                                $div.attr('title', dv.toLocaleTimeString() + ' (' + dv.toISOString() + ') - ' + titleOrg);
                            } else {
                                $div.attr('title', titleOrg);
                            }
                        }, {
                            config:     $nodeConfig.val(),
                            type:       $('#node-input-endTimeAlt').typedInput('type'),
                            value:      $('#node-input-endTimeAlt').typedInput('value'),
                            offsetType: $('#node-input-endTimeAltOffset').typedInput('type'),
                            offset:     $('#node-input-endTimeAltOffset').typedInput('value'),
                            multiplier: $('#node-input-endTimeAltOffsetMultiplier').val()
                        });
                    }
                });

                node.endTimeAltOffsetMultiplier = multiplierUpdate(node.endTimeAltOffsetMultiplier, 'endTimeAltOffsetMultiplier');
                setupTInput(node, {
                    typeProp: 'endTimeAltOffsetType',
                    valueProp: 'endTimeAltOffset',
                    width: 'calc(100% - 255px)',
                    defaultType: (node.endTimeAltOffset === 0 || node.endTimeAltOffset === '') ? types.Undefined.value : 'num',
                    defaultValue: 0,
                    types: [types.Undefined, 'num', 'flow', 'global', 'env'],
                    onChange: (_type, _value) => {
                        const type = $('#node-input-endTimeAltOffset').typedInput('type');
                        if (type === types.Undefined.value) {
                            $('#node-input-endTimeAltOffsetMultiplier').prop('disabled', true);
                        } else {
                            $('#node-input-endTimeAltOffsetMultiplier').prop('disabled', false);
                        }
                    }
                }).change();
                // #endregion timeAltEnd
                // #region Enhanced settings
                initializeValue(node, 'tsCompare', 0);
                const chkVal = (name, val) => {
                    return (node[name] === null) ||
                            (typeof node[name] === 'undefined') ||
                            ($('#node-input-' + name).val() === val) ||
                            ($('#node-input-' + name).is(':checked') === val) ||
                            (parseFloat($('#node-input-' + name).val()) === val);
                };

                if (chkVal('lastMsgOnStartOut', false) &&
                    chkVal('lastMsgOnEndOut', false) &&
                    chkVal('tsCompare', 0)) {
                    $('.enhanced-row').hide();
                } else {
                    $('.enhanced-row').show();
                }
                // #endregion Enhanced settings
                $startTime.change();
                $endTime.change();
                $propertyStart.change();
                $propertyEnd.change();
            }; // setup

            $.getScript('sun-position/js/htmlglobal.js')
                .done((_data, _textStatus, _jqxhr) => {
                    try {
                        setup(node);
                    } catch (err) {
                        console.log("failed to setup editor"); // eslint-disable-line
                        console.log(err); // eslint-disable-line
                        console.log(err.stack); // eslint-disable-line
                    }
                })
                .fail((_jqxhr, settings, exception) => {
                    console.log("failed to load htmlglobal.js"); // eslint-disable-line
                    console.log(exception); // eslint-disable-line
                    console.log(exception.stack); // eslint-disable-line
                });
        },
        oneditsave() {
            this.propertyStartType = $('#node-input-propertyStart').typedInput('type');
            this.propertyEndType = $('#node-input-propertyEnd').typedInput('type');
            this.startTimeType = $('#node-input-startTime').typedInput('type');
            this.endTimeType = $('#node-input-endTime').typedInput('type');
            this.startTimeAltType = $('#node-input-startTimeAlt').typedInput('type');
            this.endTimeAltType = $('#node-input-endTimeAlt').typedInput('type');
        }
    });</script>