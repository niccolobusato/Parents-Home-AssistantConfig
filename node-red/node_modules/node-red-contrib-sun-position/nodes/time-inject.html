<script type="text/x-red" data-template-name="time-inject">
    <div class="form-row" data-i18n="[title]node-red-contrib-sun-position/position-config:common.placeholder.positionConfig">
        <label for="node-input-positionConfig"><i class="fa fa-globe"></i> <span data-i18n="node-red-contrib-sun-position/position-config:common.label.positionConfig"></span></label>
        <input type="text" id="node-input-positionConfig">
    </div>
    <hr>
    <div class="form-row block-noindent time-payload" id="node-input-payload-div" data-i18n="[titleOrg]time-inject.placeholder.payload">
        <label for="node-input-payload"><i class="fa fa-envelope"></i> <span data-i18n="node-red:common.label.payload"></span></label>
        <input type="text" id="node-input-payload" data-i18n="[placeholder]time-inject.placeholder.payload">
        <input type="hidden" id="node-input-payloadType">
    </div>
    <div class="form-row block-indent1 time-inject-row-payloadOffset is-initial-hidden" data-i18n="[title]time-inject.placeholder.payloadOffset">
        <label for="node-input-payloadOffset"><i class="fa fa-calculator"></i> <span data-i18n="time-inject.label.payloadOffset"></span></label>
        <input id="node-input-payloadOffset" data-i18n="[placeholder]time-inject.placeholder.payloadOffset"></input>
        <input type="hidden" id="node-input-payloadOffsetType">
        <select id="node-input-payloadOffsetMultiplier" class="node-input-multiplier"></select>
    </div>
    <div class="form-row block-indent1 time-inject-row-payloadTimeFormat is-initial-hidden" data-i18n="[title]time-inject.placeholder.payloadFormat">
        <label for="node-input-payloadTimeFormatsel"><i class="fa fa-calendar"></i> <span data-i18n="time-inject.label.payloadFormat"></span></label>
        <select id="node-input-payloadTimeFormatsel">
        </select>
        <input type="text" id="node-input-payloadTimeFormat">
    </div>
    <div class="form-row block-noindent time-topic" data-i18n="[title]node-red:common.label.topic">
        <label for="node-input-topic"><i class="fa fa-tasks"></i> <span data-i18n="node-red:common.label.topic"></span></label>
        <input type="text" id="node-input-topic" data-i18n="[placeholder]node-red:common.label.topic">
    </div>
    <hr>
    <div class="form-row block-noindent" id="node-input-time-div"  data-i18n="[titleOrg]time-inject.placeholder.time">
        <label for="node-input-time"><i class="fa fa-clock-o"></i> <span data-i18n="time-inject.label.time"></span></label>
        <input type="text" id="node-input-time" />
        <input type="hidden" id="node-input-timeType">
    </div>
    <div class="form-row block-indent1 time-inject-row-offset is-initial-hidden" data-i18n="[title]time-inject.placeholder.timeOffset">
        <label for="node-input-offset"><i class="fa fa-calculator"></i> <span data-i18n="time-inject.label.timeOffset"></span></label>
        <input id="node-input-offset" data-i18n="[placeholder]time-inject.placeholder.timeOffset"></input>
        <input type="hidden" id="node-input-offsetType">
        <select id="node-input-offsetMultiplier" class="node-input-multiplier"></select>
    </div>
    <div class="form-row time-inject-row-timeDays is-initial-hidden" data-i18n="[title]time-inject.placeholder.days">
        <div id="time-inject-timeDays" class="time-inject-days" style="margin-top:5px">
            <div style="display:inline-block; vertical-align:top; margin-right:5px;" data-i18n="time-inject.label.on"></div>
            <div style="display:inline-block;">
                <div>
                    <label><input type='checkbox' checked value='1'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.days.1"></span></label>
                    <label><input type='checkbox' checked value='2'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.days.2"></span></label>
                    <label><input type='checkbox' checked value='3'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.days.3"></span></label>
                </div>
                <div>
                    <label><input type='checkbox' checked value='4'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.days.4"></span></label>
                    <label><input type='checkbox' checked value='5'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.days.5"></span></label>
                    <label><input type='checkbox' checked value='6'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.days.6"></span></label>
                </div>
                <div>
                    <label><input type='checkbox' checked value='0'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.days.0"></span></label>
                </div>
            </div>
        </div>
    </div>
    <div class="form-row form-tips" data-i18n="[html]time-inject.tips.config"></div>
    <hr class="block-noindent time-inject-row-alt is-initial-hidden">
    <div class="form-row time-inject-row-alt is-initial-hidden" data-i18n="[title]time-inject.placeholder.property">
        <label for="node-input-property"><i class="fa fa-sun-o"></i> <span data-i18n="time-inject.label.property"></span></label>
        <input type="text" id="node-input-property" data-i18n="[placeholder]time-inject.placeholder.property"/>
        <input type="hidden" id="node-input-propertyType">
        <select id="node-input-propertyCompare" class="node-input-addOn">
        </select>
    </div>
    <div class="form-row block-indent2 row-propertyThreshold is-initial-hidden" data-i18n="[title]time-inject.placeholder.propertyThreshold">
        <label for="node-input-propertyThreshold"><i class="fa fa-compress"></i> <span data-i18n="time-inject.label.propertyThreshold"></span></label>
        <input type="text" id="node-input-propertyThreshold" data-i18n="[placeholder]time-inject.placeholder.propertyThreshold">
        <input type="hidden" id="node-input-propertyThresholdType">
    </div>
    <div class="form-row block-indent1 time-inject-row-timeAlt is-initial-hidden" id="node-input-timeAlt-div" data-i18n="[titleOrg]time-inject.placeholder.timeAlt">
        <label for="node-input-timeAlt"><i class="fa fa-clock-o"></i> <span data-i18n="time-inject.label.timeAlt"></span></label>
        <input type="text" id="node-input-timeAlt" data-i18n="[placeholder]time-inject.placeholder.timeAlt"/>
        <input type="hidden" id="node-input-timeAltType">
    </div>
    <div class="form-row block-indent1 time-inject-row-timeAltOffset is-initial-hidden" data-i18n="[title]time-inject.placeholder.timeAltOffset">
        <label for="node-input-timeAltOffset"><i class="fa fa-calculator"></i> <span data-i18n="time-inject.label.timeAltOffset"></span></label>
        <input id="node-input-timeAltOffset" data-i18n="[placeholder]time-inject.placeholder.timeAltOffset"></input>
        <input type="hidden" id="node-input-timeAltOffsetType">
        <select id="node-input-timeAltOffsetMultiplier" class="node-input-multiplier"></select>
    </div>
    <div class="form-row time-inject-row-timeAltDays is-initial-hidden" data-i18n="[title]time-inject.placeholder.days">
        <div id="time-inject-timeAltDays" class="time-inject-days" style="margin-top:5px">
            <div style="display:inline-block; vertical-align:top; margin-right:5px;" data-i18n="time-inject.label.on"></div>
            <div style="display:inline-block;">
                <div>
                    <label><input type='checkbox' checked value='1'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.days.1"></span></label>
                    <label><input type='checkbox' checked value='2'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.days.2"></span></label>
                    <label><input type='checkbox' checked value='3'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.days.3"></span></label>
                </div>
                <div>
                    <label><input type='checkbox' checked value='4'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.days.4"></span></label>
                    <label><input type='checkbox' checked value='5'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.days.5"></span></label>
                    <label><input type='checkbox' checked value='6'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.days.6"></span></label>
                </div>
                <div>
                    <label><input type='checkbox' checked value='0'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.days.0"></span></label>
                </div>
            </div>
        </div>
    </div>
    <div class="form-row form-tips time-inject-row-alt is-initial-hidden">
        <span data-i18n="[html]time-inject.tips.addTimes"></span>&nbsp;
    </div>
    <hr>
    <div class="form-row" id="node-once" data-i18n="[title]time-inject.placeholder.once">
        <label for="node-input-once"><i class="fa fa-play-circle"></i> <span data-i18n="time-inject.label.once"></span></label>
        <input type="checkbox" id="node-input-once" style="display:inline-block; width:15px; vertical-align:baseline;">
        <span data-i18n="time-inject.label.onstart"></span>&nbsp;
        <input type="text" id="node-input-onceDelay" placeholder="0.1" style="width:65px; height:28px;">&nbsp;
        <span data-i18n="time-inject.label.onceDelay"></span>
    </div>
    <hr class="time-inject-recalc is-initial-hidden">
    <div class="form-row time-inject-recalc is-initial-hidden" data-i18n="[title]time-inject.placeholder.recalcTime">
        <label for="node-input-recalcTime"><i class="fa fa-arrows-h"></i> <span data-i18n="time-inject.label.recalcTime"></span></label>
        <input type="text" id="node-input-recalcTime" placeholder="2" style="width:65px; height:28px;">&nbsp;
        <span data-i18n="time-inject.label.hours"></span>
    </div>
    <div class="form-tips time-inject-recalc is-initial-hidden" data-i18n="[html]time-inject.tips.recalc"></div>
    <hr class="time-inject-addPayload">
    <div class="form-row block-noindent time-addPayload1" data-i18n="[title]time-inject.placeholder.addPayload">
        <label for="node-input-addPayload1"><i class="fa fa-plus-square-o"></i> <span data-i18n="time-inject.label.addPayload1"></span></label>
        <input type="text" id="node-input-addPayload1" data-i18n="[placeholder]time-inject.placeholder.addPayload">
        <input type="hidden" id="node-input-addPayload1Type">
    </div>
    <div class="form-row block-indent1 time-addPayload1Value is-initial-hidden" id="node-input-addPayload1-div" data-i18n="[titleOrg]time-inject.placeholder.addPayloadValue">
        <label for="node-input-addPayload1Value"><i class="fa fa-envelope-o"></i> <span data-i18n="time-inject.label.addPayload1Value"></span></label>
        <input type="text" id="node-input-addPayload1Value" data-i18n="[placeholder]time-inject.placeholder.addPayloadValue">
        <input type="hidden" id="node-input-addPayload1ValueType">
    </div>
    <div class="form-row block-indent2 time-inject-row-addPayload1Format is-initial-hidden" data-i18n="[title]time-inject.placeholder.addPayloadFormat">
        <label for="node-input-addPayload1Formatsel"><i class="fa fa-calendar"></i> <span data-i18n="time-inject.label.addPayload1Format"></span></label>
        <select id="node-input-addPayload1Formatsel"></select>
        <input type="text" id="node-input-addPayload1Format">
    </div>
    <div class="form-row block-indent2 time-inject-row-addPayload1Offset is-initial-hidden" data-i18n="[title]time-inject.placeholder.addPayloadOffset">
        <label for="node-input-addPayload1Offset"><i class="fa fa-calculator"></i> <span data-i18n="time-inject.label.addPayload1Offset"></span></label>
        <input id="node-input-addPayload1Offset" data-i18n="[placeholder]time-inject.placeholder.addPayloadOffset"></input>
        <input type="hidden" id="node-input-addPayload1OffsetType">
        <select id="node-input-addPayload1OffsetMultiplier" class="node-input-multiplier"></select>
    </div>
    <div class="form-row time-inject-row-addPayload1days is-initial-hidden" data-i18n="[title]time-inject.placeholder.days">
        <div id="time-inject-addPayload1Days" class="time-inject-days" style="margin-top:5px">
            <div style="display:inline-block; vertical-align:top; margin-right:5px;" data-i18n="time-inject.label.on"></div>
            <div style="display:inline-block;">
                <div>
                    <label><input type='checkbox' checked value='1'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.days.1"></span></label>
                    <label><input type='checkbox' checked value='2'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.days.2"></span></label>
                    <label><input type='checkbox' checked value='3'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.days.3"></span></label>
                </div>
                <div>
                    <label><input type='checkbox' checked value='4'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.days.4"></span></label>
                    <label><input type='checkbox' checked value='5'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.days.5"></span></label>
                    <label><input type='checkbox' checked value='6'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.days.6"></span></label>
                </div>
                <div>
                    <label><input type='checkbox' checked value='0'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.days.0"></span></label>
                </div>
            </div>
        </div>
    </div>
    <hr class="time-addPayload2 is-initial-hidden">
    <div class="form-row block-noindent time-addPayload2 is-initial-hidden" id="node-input-addPayload2-div" data-i18n="[titleOrg]time-inject.placeholder.addPayload">
        <label for="node-input-addPayload2"><i class="fa fa-plus-square-o"></i> <span data-i18n="time-inject.label.addPayload2"></span></label>
        <input type="text" id="node-input-addPayload2" data-i18n="[placeholder]time-inject.placeholder.addPayload">
        <input type="hidden" id="node-input-addPayload2Type">
    </div>
    <div class="form-row block-indent1 time-addPayload2Value is-initial-hidden" data-i18n="[title]time-inject.placeholder.addPayloadValue">
        <label for="node-input-addPayload2Value"><i class="fa fa-envelope-o"></i> <span data-i18n="time-inject.label.addPayload2Value"></span></label>
        <input type="text" id="node-input-addPayload2Value" data-i18n="[placeholder]time-inject.placeholder.addPayloadValue">
        <input type="hidden" id="node-input-addPayload2ValueType">
    </div>
    <div class="form-row block-indent2 time-inject-row-addPayload2Format is-initial-hidden" data-i18n="[title]time-inject.placeholder.addPayloadFormat">
        <label for="node-input-addPayload2Formatsel"><i class="fa fa-calendar"></i> <span data-i18n="time-inject.label.addPayload2Format"></span></label>
        <select id="node-input-addPayload2Formatsel">
    </select>
    <input type="text" id="node-input-addPayload2Format">
    </div>
    <div class="form-row block-indent2 time-inject-row-addPayload2Offset is-initial-hidden" data-i18n="[title]time-inject.placeholder.addPayloadOffset">
        <label for="node-input-addPayload2Offset"><i class="fa fa-calculator"></i> <span data-i18n="time-inject.label.addPayload2Offset"></span></label>
        <input id="node-input-addPayload2Offset" data-i18n="[placeholder]time-inject.placeholder.addPayloadOffset"></input>
        <input type="hidden" id="node-input-addPayload2OffsetType">
        <select id="node-input-addPayload2OffsetMultiplier" class="node-input-multiplier"></select>
    </div>
    <div class="form-row time-inject-row-addPayload2days is-initial-hidden" data-i18n="[title]time-inject.placeholder.days">
        <div id="time-inject-addPayload2Days" class="time-inject-days" style="margin-top:5px">
            <div style="display:inline-block; vertical-align:top; margin-right:5px;" data-i18n="time-inject.label.on"></div>
            <div style="display:inline-block;">
                <div>
                    <label><input type='checkbox' checked value='1'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.days.1"></span></label>
                    <label><input type='checkbox' checked value='2'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.days.2"></span></label>
                    <label><input type='checkbox' checked value='3'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.days.3"></span></label>
                </div>
                <div>
                    <label><input type='checkbox' checked value='4'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.days.4"></span></label>
                    <label><input type='checkbox' checked value='5'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.days.5"></span></label>
                    <label><input type='checkbox' checked value='6'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.days.6"></span></label>
                </div>
                <div>
                    <label><input type='checkbox' checked value='0'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.days.0"></span></label>
                </div>
            </div>
        </div>
    </div>
    <hr class="time-addPayload3 is-initial-hidden">
    <div class="form-row block-noindent time-addPayload3 is-initial-hidden" id="node-input-addPayload3-div" data-i18n="[titleOrg]time-inject.placeholder.addPayload">
        <label for="node-input-addPayload3"><i class="fa fa-plus-square-o"></i> <span data-i18n="time-inject.label.addPayload3"></span></label>
        <input type="text" id="node-input-addPayload3" data-i18n="[placeholder]time-inject.placeholder.addPayload">
        <input type="hidden" id="node-input-addPayload3Type">
    </div>
    <div class="form-row block-indent1 time-addPayload3Value is-initial-hidden" data-i18n="[title]time-inject.placeholder.addPayloadValue">
        <label for="node-input-addPayload3Value"><i class="fa fa-envelope-o"></i> <span data-i18n="time-inject.label.addPayload3Value"></span></label>
        <input type="text" id="node-input-addPayload3Value" data-i18n="[placeholder]time-inject.placeholder.addPayloadValue">
        <input type="hidden" id="node-input-addPayload3ValueType">
    </div>
    <div class="form-row block-indent2 time-inject-row-addPayload3Format is-initial-hidden" data-i18n="[title]time-inject.placeholder.addPayloadFormat">
        <label for="node-input-addPayload3Formatsel"><i class="fa fa-calendar"></i> <span data-i18n="time-inject.label.addPayload3Format"></span></label>
        <select id="node-input-addPayload3Formatsel"></select>
        <input type="text" id="node-input-addPayload3Format" >
    </div>
    <div class="form-row block-indent2 time-inject-row-addPayload3Offset is-initial-hidden" data-i18n="[title]time-inject.placeholder.addPayloadOffset">
        <label for="node-input-addPayload3Offset"><i class="fa fa-calculator"></i> <span data-i18n="time-inject.label.addPayload3Offset"></span></label>
        <input id="node-input-addPayload3Offset" data-i18n="[placeholder]time-inject.placeholder.addPayloadOffset"></input>
        <input type="hidden" id="node-input-addPayload3OffsetType">
        <select id="node-input-addPayload3OffsetMultiplier" class="node-input-multiplier"></select>
    </div>
    <div class="form-row time-inject-row-addPayload3days is-initial-hidden" data-i18n="[title]time-inject.placeholder.days">
        <div id="time-inject-addPayload3Days" class="time-inject-days" style="margin-top:5px">
            <div style="display:inline-block; vertical-align:top; margin-right:5px;" data-i18n="time-inject.label.on"></div>
            <div style="display:inline-block;">
                <div>
                    <label><input type='checkbox' checked value='1'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.days.1"></span></label>
                    <label><input type='checkbox' checked value='2'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.days.2"></span></label>
                    <label><input type='checkbox' checked value='3'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.days.3"></span></label>
                </div>
                <div>
                    <label><input type='checkbox' checked value='4'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.days.4"></span></label>
                    <label><input type='checkbox' checked value='5'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.days.5"></span></label>
                    <label><input type='checkbox' checked value='6'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.days.6"></span></label>
                </div>
                <div>
                    <label><input type='checkbox' checked value='0'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.days.0"></span></label>
                </div>
            </div>
        </div>
    </div>
    <div class="form-row form-tips time-inject-addPayload" data-i18n="[html]time-inject.tips.addPayload"></div>
    <hr>
    <div class="form-row" data-i18n="[title]node-red:common.label.name">
        <label for="node-input-name"><i class="icon-tag"></i> <span data-i18n="node-red:common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]node-red:common.label.name">
    </div>
</script>
<style>
    hr {
        width: 100%
    }
    .is-to-show-initially {
        display:none
    }
    .is-initial-hidden {
        display:none
    }
    .form-tips {
        width: 90%
    }
    .block-indent1 {
        float: left;
        min-height: 1px;
        margin-left: 10px;
        width: 100%
    }
    .block-indent2 {
        float: left;
        min-height: 1px;
        margin-left: 20px;
        width: 100%
    }
    .block-noindent .row-full-width {
        width : calc(100% - 110px);
    }
    .block-indent1 .row-full-width {
        width : calc(100% - 120px);
    }
    .block-indent2 .row-full-width {
        width : calc(100% - 130px);
    }
    .block-noindent .ui-spinner {
        width : calc(100% - 245px);
    }
    .block-indent1 .ui-spinner {
        width : calc(100% - 255px);
    }
    .block-indent2 .ui-spinner {
        width : calc(100% - 265px);
    }
    .node-input-multiplier {
        width: 125px;
        max-width: 125px;
        margin-left: 5px;
    }
    .time-inject-row-timeDays,
    .time-inject-row-timeAltDays,
    .time-inject-row-addPayload1days,
    .time-inject-row-addPayload2days,
    .time-inject-row-addPayload3days {
        padding-left: 110px;
    }
    .time-inject-row-timeDays select,
    .time-inject-row-timeAltDays select,
    .time-inject-row-addPayload1days select,
    .time-inject-row-addPayload2days select,
    .time-inject-row-addPayload2days select {
        margin: 3px 0;
    }
    .time-inject-days label {
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        vertical-align: baseline;
        width: 100px;
    }
    .time-inject-days input {
        width: auto;
        vertical-align: baseline;
    }
    .node-input-addOn {
        width: 100px;
        max-width: 100px;
        margin-left: 5px;
    }
</style>

<script type="text/javascript">
    function clipValueLength(v, l) {
        l = l || 18;
        return (v.length > l) ? v.slice(0, (l - 3)) + '...' : v;
    }

    function getValueLabel(node, t, v, offset, l) {
        l = l || 20;
        let suffix = '';
        if (offset && offset > 0) {
            suffix = '↷';
        } else if (offset && offset < 0) {
            suffix = '↶';
        }

        if (t === 'jsonata') {
            if (v.length < l) { return v + suffix; }
            return node._('node-red-contrib-sun-position/position-config:common.label.jsonata') + suffix;
        }

        if (t === 'json') {
            if (v.length < l) { return  v + suffix; }
            return node._('node-red-contrib-sun-position/position-config:common.label.json') + suffix;
        }

        if (t === 'bin') {
            return node._('node-red-contrib-sun-position/position-config:common.label.binary') + suffix;
        }

        if (t === 'date') {
            return node._('node-red-contrib-sun-position/position-config:common.label.timestamp') + suffix;
        }

        if (t === 'dateSpecific') {

            return node._('node-red-contrib-sun-position/position-config:common.label.timestamp') + '+' + suffix;
        }

        if (t === 'string' || t === 'str' || t === 'DayOfMonth') {
            if (v === '') { return node._('node-red-contrib-sun-position/position-config:common.label.blank') + suffix; }
            return '"' + clipValueLength(v, l) + '"' + suffix;
        }

        if (t === 'num') {
            if (v === '') { return '0' + suffix; }
            return String(v) + suffix;
        }

        if (t === 'bool') {
            if (v === '') { return 'false' + suffix; }
            return String(v) + suffix;
        }

        if (t === 'msg') {
            return t + '.' + clipValueLength(v, l) + suffix;
        }

        if (t === 'flow' || t === 'global') {
            const result = RED.utils.parseContextKey(v);
            return t + '.' + clipValueLength(result.key, l) + suffix;
        }

        if (t === 'pdsCalcData') {
            return '{sun position}' + suffix;
        }

        if (t === 'pdmCalcData') {
            return '{moon position}' + suffix;
        }

        if (t === 'pdsTime') {
            const res = v.replace('astronomical', 'astro-').replace('nautical', 'naut-').replace('amateur', 'amat-').replace('blueHour', 'blueHr-').replace('goldenHour', 'goldHr-');
            return clipValueLength(res, l) + suffix;
        }

        if (t === 'pdmTime') {
            return 'moon' + v + suffix;
        }

        if (v === '') {
            return node._('node-red-contrib-sun-position/position-config:common.label.blank');
        }

        return clipValueLength(v, l) + suffix;
    }

    RED.nodes.registerType('time-inject', {
        category: 'time and astro',
        color: '#a6bbcf',
        icon: 'injectSun-white.png',
        inputs: 0,
        outputs: 1,
        defaults: {
            name: {
                value: ''
            },
            positionConfig: {
                value: '',
                type: 'position-config',
                required: true
            },
            payload: {
                value: '',
                validate: RED.validators.typedInput('payloadType')
            },
            payloadType: {
                value: 'date'
            },
            payloadTimeFormat: {
                value: 0
            },
            payloadOffset: {
                value: 0,
                validate: (v) => {
                    return (
                        (typeof v === 'undefined') ||
                        (typeof this.payloadOffsetType === 'undefined') ||
                        RED.validators.typedInput('payloadOffsetType')(v)
                    );
                }
            },
            payloadOffsetType: {
                value: 'none'
            },
            payloadOffsetMultiplier: {
                value: 60000
            },
            topic: {
                value: ''
            },
            time: {
                value: '',
                required: false,
                validate: RED.validators.typedInput('timeType')
            },
            timeType: {
                value: 'none'
            },
            timeDays: {
                value: '*',
                required: true
            },
            offset: {
                value: 0,
                validate: (v) => {
                    return (
                        (typeof v === 'undefined') ||
                        (typeof this.offsetType === 'undefined') ||
                        RED.validators.typedInput('offsetType')(v) ||
                        ($('#node-input-time').length ?
                            $('#node-input-time').typedInput('type') === 'none' :
                            this.timeType === 'none')
                    );
                }
            },
            offsetType: {
                value: 'none'
            },
            offsetMultiplier: {
                value: 60000,
                required: true,
                validate: (v) => {
                    return (
                        typeof v === 'undefined' ||
                        RED.validators.number()(v) ||
                        $('#node-input-offsetType').typedInput('type') === 'none' ||
                        this.offsetType === 'none' ||
                        ($('#node-input-time').length ?
                            $('#node-input-time').typedInput('type') === 'none' :
                            this.timeType === 'none')
                    );
                }
            },
            property: {
                value: '',
                required: false,
                validate: (v) => {
                    return (
                        typeof v === 'undefined' ||
                        typeof this.propertyType === 'undefined' ||
                        RED.validators.typedInput('propertyType')(v) ||
                        ($('#node-input-time').length ?
                            $('#node-input-time').typedInput('type') === 'none' :
                            this.timeType === 'none')
                    );
                }
            },
            propertyType: {
                value: 'none'
            },
            propertyCompare: {
                value: 'true'
            },
            propertyThreshold: {
                value: '',
                validate: function (v) {
                    return (
                        typeof v === 'undefined' ||
                        RED.validators.typedInput('propertyThresholdType')(v) ||
                        ($('#node-input-timeType').length ?
                            $('#node-input-time').typedInput('type') === 'none' :
                            this.timeType === 'none') ||
                        typeof this.propertyType === 'undefined' ||
                        ($('#node-input-propertyType').length ?
                            $('#node-input-property').typedInput('type') === 'none' :
                            this.propertyType === 'none')
                    );
                }
            },
            propertyThresholdType: {
                value: 'num'
            },
            timeAlt: {
                value: '',
                required: false,
                validate: (v) => {
                    return (
                        RED.validators.typedInput('timeAltType')(v) ||
                        ($('#node-input-timeType').length ?
                            $('#node-input-time').typedInput('type') === 'none' :
                            this.timeType === 'none') ||
                        typeof this.propertyType === 'undefined' ||
                        ($('#node-input-propertyType').length ?
                            $('#node-input-property').typedInput('type') === 'none' :
                            this.propertyType === 'none')
                    );
                }
            },
            timeAltType: {
                value: 'entered'
            },
            timeAltOffset: {
                value: 0,
                validate: (v) => {
                    return (
                        typeof v === 'undefined' ||
                        (typeof this.timeAltOffsetType === 'undefined') ||
                        RED.validators.typedInput('timeAltOffsetType')(v) ||
                        ($('#node-input-time').length ?
                            $('#node-input-time').typedInput('type') === 'none' :
                            this.timeType === 'none') ||
                        typeof this.propertyType === 'undefined' ||
                        ($('#node-input-propertyType').length ?
                            $('#node-input-property').typedInput('type') === 'none' :
                            this.propertyType === 'none')
                    );
                }
            },
            timeAltOffsetType: {
                value: 'none'
            },
            timeAltOffsetMultiplier: {
                value: 60000,
                required: true,
                validate: (v) => {
                    return (
                        typeof v === 'undefined' ||
                        RED.validators.number()(v) ||
                        $('#node-input-timeAltOffsetType').typedInput('type') === 'none' ||
                        this.timeAltOffsetType === 'none' ||
                        ($('#node-input-time').length ?
                            $('#node-input-time').typedInput('type') === 'none' :
                            this.timeType === 'none') ||
                        typeof this.propertyType === 'undefined' ||
                        ($('#node-input-propertyType').length ?
                            $('#node-input-property').typedInput('type') === 'none' :
                            this.propertyType === 'none')
                    );
                }
            },
            once: {
                value: false
            },
            onceDelay: {
                value: 0.1,
                validate: (v) => {
                    return (
                        RED.validators.number()(v) ||
                        v === '' ||
                        v === null ||
                        typeof v === 'undefined'
                    );
                }
            },
            addPayload1: {
                value: '',
                validate: (v) => {
                    return (
                        typeof this.addPayload1Type === 'undefined' ||
                        typeof v === 'undefined' ||
                        RED.validators.typedInput('addPayload1Type')(v)
                    );
                }
            },
            addPayload1Type: {
                value: 'none'
            },
            addPayload1Value: {
                value: '',
                validate: (v) => {
                    return (
                        RED.validators.typedInput('addPayload1ValueType')(v) ||
                        $('#node-input-addPayload1').typedInput('type') === 'none' ||
                        typeof this.addPayload1Type === 'undefined'
                    );
                }
            },
            addPayload1ValueType: {
                value: 'date'
            },
            addPayload1Format: {
                value: 0
            },
            addPayload1Offset: {
                value: 0,
                validate: (v) => {
                    return (
                        (typeof v === 'undefined') ||
                        (typeof this.addPayload1OffsetType === 'undefined') ||
                        RED.validators.typedInput('addPayload1OffsetType')(v) ||
                        $('#node-input-addPayload1OffsetType').typedInput('type') === 'none' ||
                        this.addPayload1OffsetType === 'none' ||
                        $('#node-input-addPayload1').typedInput('type') === 'none' ||
                        typeof this.addPayload1Type === 'undefined'
                    );
                }
            },
            addPayload1OffsetType: {
                value: 'none'
            },
            addPayload1OffsetMultiplier: {
                value: 60000,
                required: true,
                validate: (v) => {
                    return (
                        RED.validators.number()(v) ||
                        $('#node-input-addPayload1OffsetType').typedInput('type') === 'none' ||
                        this.addPayload1OffsetType === 'none' ||
                        $('#node-input-addPayload1').typedInput('type') === 'none' ||
                        typeof this.addPayload1Type === 'undefined'
                    );
                }
            },
            addPayload1Days: {
                value: '*',
                required: true
            },
            addPayload2: {
                value: '',
                validate: (v) => {
                    return (
                        typeof this.addPayload2Type === 'undefined' ||
                        typeof v === 'undefined' ||
                        RED.validators.typedInput('addPayload2Type')(v)
                    );
                }
            },
            addPayload2Type: {
                value: 'none'
            },
            addPayload2Value: {
                value: '',
                validate: (v) => {
                    return (
                        RED.validators.typedInput('addPayload2ValueType')(v) ||
                        $('#node-input-addPayload2').typedInput('type') === 'none' ||
                        typeof this.addPayload2Type === 'undefined'
                    );
                }
            },
            addPayload2ValueType: {
                value: 'date'
            },
            addPayload2Format: {
                value: 0
            },
            addPayload2Offset: {
                value: 0,
                validate: (v) => {
                    return (
                        (typeof v === 'undefined') ||
                        (typeof this.addPayload2OffsetType === 'undefined') ||
                        RED.validators.typedInput('addPayload2OffsetType')(v) ||
                        $('#node-input-addPayload2').typedInput('type') === 'none' ||
                        typeof this.addPayload2Type === 'undefined'
                    );
                }
            },
            addPayload2OffsetType: {
                value: 'none'
            },
            addPayload2OffsetMultiplier: {
                value: 60000,
                required: true,
                validate: (v) => {
                    return (
                        RED.validators.number()(v) ||
                        $('#node-input-addPayload2OffsetType').typedInput('type') === 'none' ||
                        this.addPayload2OffsetType === 'none' ||
                        $('#node-input-addPayload2').typedInput('type') === 'none' ||
                        typeof this.addPayload2Type === 'undefined'
                    );
                }
            },
            addPayload2Days: {
                value: '*',
                required: true
            },
            addPayload3: {
                value: '',
                validate: (v) => {
                    return (
                        typeof this.addPayload3Type === 'undefined' ||
                        typeof v === 'undefined' ||
                        RED.validators.typedInput('addPayload3Type')(v)
                    );
                }
            },
            addPayload3Type: {
                value: 'none'
            },
            addPayload3Value: {
                value: '',
                validate: (v) => {
                    return (
                        RED.validators.typedInput('addPayload3ValueType')(v) ||
                        $('#node-input-addPayload3').typedInput('type') === 'none' ||
                        typeof this.addPayload3Type === 'undefined'
                    );
                }
            },
            addPayload3ValueType: {
                value: 'date'
            },
            addPayload3Format: {
                value: 0
            },
            addPayload3Offset: {
                value: 0,
                validate: (v) => {
                    return (
                        (typeof v === 'undefined') ||
                        (typeof this.addPayload3OffsetType === 'undefined') ||
                        RED.validators.typedInput('addPayload3OffsetType')(v) ||
                        $('#node-input-addPayload3').typedInput('type') === 'none' ||
                        typeof this.addPayload3Type === 'undefined'
                    );
                }
            },
            addPayload3OffsetType: {
                value: 'none'
            },
            addPayload3OffsetMultiplier: {
                value: 60000,
                required: true,
                validate: (v) => {
                    return (
                        RED.validators.number()(v) ||
                        $('#node-input-addPayload3OffsetType').typedInput('type') === 'none' ||
                        this.addPayload3OffsetType === 'none' ||
                        $('#node-input-addPayload3').typedInput('type') === 'none' ||
                        typeof this.addPayload3Type === 'undefined'
                    );
                }
            },
            addPayload3Days: {
                value: '*',
                required: true
            },
            recalcTime: {
                value: 2,
                validate: (v) => {
                    return (
                        RED.validators.number()(v) ||
                        v === '' ||
                        v === null ||
                        typeof v === 'undefined'
                    );
                }
            }
        },
        outputLabels(_index) {
            const labels = {
                str: 'string',
                num: 'number',
                bool: 'boolean',
                json: 'object',
                flow: 'flow context',
                global: 'global context',
                bin: 'binary data',
                date: 'timestamp',
                env: 'Environment variable',
                jsonata: 'result of jsonata expression',
                pdmTime: 'time',
                typeSunCalc: 'object of sun position',
                typeMoonCalc: 'object of moon position'
            };
            let lab = labels[this.payloadType] || this.payloadType;
            if (lab === 'object') {
                try {
                    lab = typeof JSON.parse(this.payload);
                    if (lab === 'object') {
                        if (Array.isArray(JSON.parse(this.payload))) {
                            lab = 'Array';
                        }
                    }
                } catch (e) {
                    lab = 'Invalid JSON Object';
                }
            }

            return lab;
        },
        label() {
            if (this.name) {
                return this.name;
            }

            let result = '';
            if (this.once) {
                result += '¹';
            }

            const getTimeId = () => {
                let suffix = '';
                const days = this.timeDays;
                if (days && days !== '*' && days !== '1,2,3,4,5,6,0') {
                    if (days === '1,2,3,4,5') {
                        suffix += ' [Mo-Fr]'; // '👷'
                    } else if (days === '1,2,3,4') {
                        suffix += ' [Mo-Th]';
                    } else if (days === '5,6,0') {
                        suffix += ' [Fr-Su]';
                    } else if (days === '6,0') {
                        suffix += ' [Sa+Su]';
                    } else {
                        const dayArr = [];
                        if (days.indexOf('1') >= 0) {
                            dayArr.push('Mo');
                        }

                        if (days.indexOf('2') >= 0) {
                            dayArr.push('Tu');
                        }

                        if (days.indexOf('3') >= 0) {
                            dayArr.push('We');
                        }

                        if (days.indexOf('4') >= 0) {
                            dayArr.push('Th');
                        }

                        if (days.indexOf('5') >= 0) {
                            dayArr.push('Fr');
                        }

                        if (days.indexOf('6') >= 0) {
                            dayArr.push('Sa');
                        }

                        if (days.indexOf('0') >= 0) {
                            dayArr.push('Su');
                        }

                        suffix += ' [' + dayArr.join(',') + ']';
                    }
                    // ...
                }

                const part1 = getValueLabel(this, this.timeType, this.time, this.offset);
                if (this.propertyType !== 'none' && this.propertyType !== '' && this.timeAlt) {
                    return (part1 + '/' + getValueLabel(this, this.timeAltType, this.timeAlt, this.timeAltOffset) + suffix);
                }

                return part1 + suffix;
            };

            if (this.timeType === 'none' || this.timeType === '') {
                result += getValueLabel(this, this.payloadType, this.payload, this.payloadOffset, 12);
            } else {
                const timeTxt = getTimeId();
                if (timeTxt.length > 26) {
                    result += timeTxt + ' =...';
                } else {
                    result += timeTxt + ' = ' + getValueLabel(this, this.payloadType, this.payload, this.payloadOffset, 14);
                }
            }

            if (this.topic && this.topic.length + result.length <= 32) {
                return this.topic + ':' + result;
            }

            return result;
        },
        labelStyle() {
            return this.name ? 'node_label_italic' : '';
        },
        paletteLabel: 'time inject',
        align: 'left',
        oneditprepare() {
            setTimeout(() => {
                $('.is-to-show-initially').show();
                $('.is-to-hide-initially').hide();
            }, 300);
            const node = this;
            const $nodeConfig = $('#node-input-positionConfig');
            const setup = function(node) {
                /* global initializeValue getTypes getSelectFields appendOptions setupTInput initCombobox initDaysCheckbox getTimeData getOutDataData */
                const types = getTypes(node);
                const selFields = getSelectFields();
                // #region initialize
                function getDaysStr(value) {
                    const days = value.map((_, el) => { return $(el).val(); }).get();
                    if (days.length === 0) { return ''; }
                    if (days.length === 7) { return '*'; }
                    return days.join(',');
                }

                function multiplierUpdate(mp, name) {
                    const field = $('#node-input-' + name);
                    appendOptions(node, field, 'multiplier', (data) => (data.id > 0));
                    if (mp === null || typeof mp === 'undefined' || isNaN(mp) || mp === '' || mp === 0) {
                        mp = 60000;
                    } else {
                        mp = parseFloat(mp);
                        if (mp === 1) {
                            mp = 1000;
                        } else if (mp === 60) {
                            mp = 60000;
                        } else if (mp === 3600) {
                            mp = 3600000;
                        }
                    }
                    field.val(mp);
                    return mp;
                }

                initializeValue(node, 'timeDays', '*');
                initializeValue(node, 'timeAltDays', '*');
                initializeValue(node, 'addPayload1Days', '*');
                initializeValue(node, 'addPayload2Days', '*');
                initializeValue(node, 'addPayload3Days', '*');
                // #endregion initialize
                // #region spinner
                $('#node-input-once').change(() => {
                    $('#node-input-onceDelay').attr('disabled', !$('#node-input-once').prop('checked'));
                });

                $('.wt-offset-time').spinner({
                    max: 1439,
                    min: -1439
                });
                $('#node-input-onceDelay').spinner({
                    step: 0.1,
                    numberFormat: 'n'
                });
                $('#node-input-recalcTime').spinner({
                    step: 0.1,
                    numberFormat: 'n'
                });
                // #endregion spinner
                // #region payload
                if (node.payloadType === null) {
                    if (node.payload === '') {
                        node.payloadType = 'date';
                    } else {
                        node.payloadType = 'str';
                    }
                } else if (node.payloadType === 'string' || node.payloadType === types.Undefined.value) {
                    node.payloadType = 'str';
                }
                const $payload = setupTInput(node, {
                    typeProp: 'payloadType',
                    valueProp: 'payload',
                    width: 'calc(100% - 110px)',
                    defaultType: 'date',
                    types: [
                        'date',
                        types.DateSpecific,
                        types.TimeEntered,
                        types.DateEntered,
                        types.TimeSun,
                        types.TimeMoon,
                        types.DayOfMonth,
                        'flow',
                        'global',
                        'str',
                        'num',
                        'bool',
                        'json',
                        'bin',
                        'env',
                        'jsonata',
                        types.SunCalc,
                        types.MoonCalc
                    ],
                    onChange: (_type, _value) => {
                        const plVType = $('#node-input-payload').typedInput('type');
                        if (plVType ===  types.TimeEntered.value ||
                            plVType === types.TimeSun.value ||
                            plVType === types.TimeMoon.value ||
                            plVType === types.DateSpecific.value) {
                            $('.time-inject-row-payloadTimeFormat').show();
                            $('.time-inject-row-payloadOffset').show();
                        } else {
                            $('.time-inject-row-payloadTimeFormat').hide();
                            $('.time-inject-row-payloadOffset').hide();
                        }
                        getOutDataData(d => {
                            const $div = $('#node-input-payload-div');
                            const titleOrg = $div.attr('titleOrg');
                            if (d) {
                                $div.attr('title', d + ' - ' + titleOrg);
                            } else {
                                $div.attr('title', titleOrg);
                            }
                        }, {
                            config:     $nodeConfig.val(),
                            type:       plVType,
                            value:      $('#node-input-payload').typedInput('value'),
                            format:     $('#node-input-payloadTimeFormat').val(),
                            offsetType: $('#node-input-payloadOffset').typedInput('type'),
                            offset:     $('#node-input-payloadOffset').typedInput('value'),
                            multiplier: $('#node-input-payloadOffsetMultiplier').val()
                        });
                    }
                });
                initCombobox(node, $('#node-input-payloadTimeFormatsel'), $('#node-input-payloadTimeFormat'), 'dateOutFormat', 'outputFormats', node.payloadTimeFormat || 0, 30);

                node.payloadOffsetMultiplier = multiplierUpdate(node.payloadOffsetMultiplier, 'payloadOffsetMultiplier');
                setupTInput(node, {
                    typeProp: 'payloadOffsetType',
                    valueProp: 'payloadOffset',
                    width: 'calc(100% - 255px)',
                    defaultType: (node.payloadOffset === 0 || node.payloadOffset === '') ? types.Undefined.value : 'num',
                    defaultValue: 0,
                    types: [types.Undefined, 'num', 'flow', 'global', 'env'],
                    onChange: (_type, _value) => {
                        const type = $('#node-input-payloadOffset').typedInput('type');
                        if (type === types.Undefined.value) {
                            $('#node-input-payloadOffsetMultiplier').prop('disabled', true);
                        } else {
                            $('#node-input-payloadOffsetMultiplier').prop('disabled', false);
                        }
                    }
                }).change();
                // #endregion payload
                // #region time
                const $time = setupTInput(node, {
                    typeProp: 'timeType',
                    valueProp: 'time',
                    width: 'calc(100% - 110px)',
                    defaultType: types.Undefined.value,
                    defaultValue: '',
                    types: [types.Undefined, types.TimeEntered, types.TimeSun, types.TimeMoon, 'flow', 'global', 'env'],
                    onChange: (_type, _value) => {
                        const type = $('#node-input-time').typedInput('type');
                        if (type === types.Undefined.value) {
                            $('.time-inject-row-offset').hide();
                            $('.time-inject-row-timeDays').hide();
                            $('.time-inject-row-alt').hide();

                            const $div = $('#node-input-time-div');
                            const titleOrg = $div.attr('titleOrg');
                            $div.attr('title', titleOrg);
                        } else {
                            $('.time-inject-row-offset').show();
                            $('.time-inject-row-timeDays').show();
                            $('.time-inject-row-alt').show();

                            getTimeData(d => {
                                const $div = $('#node-input-time-div');
                                const titleOrg = $div.attr('titleOrg');
                                if (d.value) {
                                    const dv = new Date(d.value);
                                    $div.attr('title', dv.toLocaleTimeString() + ' (' + dv.toISOString() + ') - ' + titleOrg);
                                } else {
                                    $div.attr('title', titleOrg);
                                }
                            }, {
                                config:     $nodeConfig.val(),
                                type:       type,
                                value:      $('#node-input-time').typedInput('value'),
                                offsetType: $('#node-input-offset').typedInput('type'),
                                offset:     $('#node-input-offset').typedInput('value'),
                                multiplier: $('#node-input-offsetMultiplier').val(),
                                next: 1,
                                days:       getDaysStr($('#time-inject-timeDays input[type=checkbox]:checked'))
                            });
                        }
                        $('#node-input-property').change();
                    }
                });
                initDaysCheckbox('#time-inject-timeDays', node.timeDays);

                node.offsetMultiplier = multiplierUpdate(node.offsetMultiplier, 'offsetMultiplier');
                setupTInput(node, {
                    typeProp: 'offsetType',
                    valueProp: 'offset',
                    width: 'calc(100% - 255px)',
                    defaultType: (node.offset === 0 || node.offset === '') ? types.Undefined.value : 'num',
                    defaultValue: 0,
                    types: [types.Undefined, 'num', 'msg', 'flow', 'global', 'env'],
                    onChange: (_type, _value) => {
                        const type = $('#node-input-offset').typedInput('type');
                        if (type === types.Undefined.value) {
                            $('#node-input-offsetMultiplier').prop('disabled', true);
                        } else {
                            $('#node-input-offsetMultiplier').prop('disabled', false);
                        }
                    }
                }).change();
                // #endregion time
                // #region property
                setupTInput(node, {
                    typeProp: 'propertyType',
                    valueProp: 'property',
                    width: 'calc(100% - 110px)',
                    defaultType: types.Undefined.value,
                    defaultValue: '',
                    types: [types.Undefined, 'flow', 'global', 'jsonata', 'env'],
                    onChange: (_type, _value) => {
                        const timeType = $('#node-input-time').typedInput('type');
                        const propType = $('#node-input-property').typedInput('type');
                        if ( timeType === types.Undefined.value || propType === types.Undefined.value ) {
                            $('.time-inject-row-timeAlt').hide();
                            $('.time-inject-row-timeAltOffset').hide();
                            $('.time-inject-row-timeAltDays').hide();
                            $('#node-input-propertyCompare').hide();
                            $('.row-propertyThreshold').hide();
                            $('#node-input-property').typedInput('width', 'calc(100% - 110px)');
                        } else if(propType === 'jsonata') {
                            $('.time-inject-row-timeAlt').show();
                            $('.time-inject-row-timeAltOffset').show();
                            $('.time-inject-row-timeAltDays').show();
                            $('#node-input-propertyCompare').show();
                            $('#node-input-propertyCompare').attr('disabled', true);
                            $('#node-input-propertyCompare').val(selFields.comparator[0].id); // only true is valid for jsonata
                            $('.row-propertyThreshold').hide();
                            $('#node-input-property').typedInput('width', 'calc(100% - 220px)');
                        } else {
                            $('.time-inject-row-timeAlt').show();
                            $('.time-inject-row-timeAltOffset').show();
                            $('.time-inject-row-timeAltDays').show();
                            $('#node-input-propertyCompare').show();
                            $('#node-input-propertyCompare').attr('disabled', false);
                            $('#node-input-property').typedInput('width', 'calc(100% - 220px)');
                            const condOp = $('#node-input-propertyCompare').val();
                            let operatorCount = 1;
                            const fields = selFields.comparator;
                            const fieldsLength = fields.length;
                            for(let index = 0; index<fieldsLength; index++) {
                                const el = fields[index];
                                if (el.id === condOp) {
                                    operatorCount = el.operatorCount;
                                    break;
                                }
                            }

                            if (operatorCount > 1) {
                                $('.row-propertyThreshold').show(); // condOpB
                            } else {
                                $('.row-propertyThreshold').hide(); // condOpB
                            }
                        }

                        if ( timeType === 'flow' || timeType === 'global' || propType !== types.Undefined.value ) {
                            $('.time-inject-recalc').show();
                        } else {
                            $('.time-inject-recalc').hide();
                            $('#time-inject-recalcTime').val('');
                        }
                        $('#node-input-propertyThreshold').change();
                    }
                });
                const propertyCompareField = $('#node-input-propertyCompare');
                appendOptions(node, propertyCompareField, 'comparator');
                propertyCompareField.val(node.propertyCompare || 'true');
                propertyCompareField.change(() => { $('#node-input-property').change(); });
                setupTInput(node, {
                    typeProp: 'propertyThresholdType',
                    valueProp: 'propertyThreshold',
                    width: 'calc(100% - 130px)',
                    defaultType: 'num',
                    defaultValue: '',
                    types: ['msg', 'flow', 'global', 'str', 'num', 'env']
                });
                // #endregion property
                // #region timeAlt
                const $timeAlt = setupTInput(node, {
                    typeProp: 'timeAltType',
                    valueProp: 'timeAlt',
                    width: 'calc(100% - 120px)',
                    defaultType: 'entered',
                    defaultValue: '',
                    types: [types.TimeEntered, types.TimeSun, types.TimeMoon, 'flow', 'global', 'env'],
                    onChange: (_type, _value) => {
                        if (!$('.time-inject-row-timeAlt').is(':hidden')) {
                            getTimeData(d => {
                                const $div = $('#node-input-timeAlt-div');
                                const titleOrg = $div.attr('titleOrg');
                                if (d.value) {
                                    const dv = new Date(d.value);
                                    $div.attr('title', dv.toLocaleTimeString() + ' (' + dv.toISOString() + ') - ' + titleOrg);
                                } else {
                                    $div.attr('title', titleOrg);
                                }
                            }, {
                                config:     $nodeConfig.val(),
                                type:       $('#node-input-timeAlt').typedInput('type'),
                                value:      $('#node-input-timeAlt').typedInput('value'),
                                offsetType: $('#node-input-timeAltOffset').typedInput('type'),
                                offset:     $('#node-input-timeAltOffset').typedInput('value'),
                                multiplier: $('#node-input-timeAltOffsetMultiplier').val(),
                                next: 1,
                                days:       getDaysStr($('#time-inject-timeAltDays input[type=checkbox]:checked'))
                            });
                        }
                    }
                });

                initDaysCheckbox('#time-inject-timeAltDays', node.timeAltDays);

                node.timeAltOffsetMultiplier = multiplierUpdate(node.timeAltOffsetMultiplier, 'timeAltOffsetMultiplier');
                setupTInput(node, {
                    typeProp: 'timeAltOffsetType',
                    valueProp: 'timeAltOffset',
                    width: 'calc(100% - 255px)',
                    defaultType: (node.timeAltOffset === 0 || node.timeAltOffset === '') ? types.Undefined.value : 'num',
                    defaultValue: 0,
                    types: [types.Undefined, 'num', 'flow', 'global', 'env'],
                    onChange: (_type, _value) => {
                        const type = $('#node-input-timeAltOffset').typedInput('type');
                        if (type === types.Undefined.value) {
                            $('#node-input-timeAltOffsetMultiplier').prop('disabled', true);
                        } else {
                            $('#node-input-timeAltOffsetMultiplier').prop('disabled', false);
                        }
                    }
                }).change();
                // #endregion timeAlt
                // #region addPayload1
                if (node.addPayload1Type === types.MsgPayload.value) {
                    node.addPayload1Type = 'msg';
                    node.addPayload1 = 'payload';
                }
                const $addPayload1 = setupTInput(node, {
                    typeProp: 'addPayload1Type',
                    valueProp: 'addPayload1',
                    width: 'calc(100% - 110px)',
                    defaultType: types.Undefined.value,
                    defaultValue: '',
                    types: [types.Undefined, 'msg', types.MsgTs, types.MsgLc, types.MsgValue, 'flow', 'global'],
                    onChange: (_type, _value) => {
                        const plType = $('#node-input-addPayload1').typedInput('type');
                        if (plType !== types.Undefined.value) {
                            $('.time-addPayload1Value').show();
                            $('.time-addPayload2').show();
                            const plVType = $('#node-input-addPayload1Value').typedInput('type');
                            if (plVType === types.TimeEntered.value ||
                                plVType === types.TimeSun.value ||
                                plVType === types.TimeMoon.value) {
                                $('.time-inject-row-addPayload1Format').show();
                                $('.time-inject-row-addPayload1Offset').show();
                                $('.time-inject-row-addPayload1days').show();
                            } else if (plVType === types.DateSpecific.value ||
                                       plVType === types.DateEntered.value ||
                                       plVType === types.DayOfMonth.value) {
                                $('.time-inject-row-addPayload1Format').show();
                                $('.time-inject-row-addPayload1Offset').show();
                                $('.time-inject-row-addPayload1days').hide();
                            } else {
                                $('.time-inject-row-addPayload1Format').hide();
                                $('.time-inject-row-addPayload1Offset').hide();
                                $('.time-inject-row-addPayload1days').hide();
                            }
                        } else {
                            $('.time-addPayload1Value').hide();
                            $('.time-inject-row-addPayload1Format').hide();
                            $('.time-inject-row-addPayload1Offset').hide();
                            $('.time-inject-row-addPayload1days').hide();
                            $('.time-addPayload2').hide();
                        }
                        $('#node-input-addPayload2').change();
                    }
                });

                setupTInput(node, {
                    typeProp: 'addPayload1ValueType',
                    valueProp: 'addPayload1Value',
                    width: 'calc(100% - 120px)',
                    defaultType: 'date',
                    defaultValue: '',
                    types: [
                        'date',
                        types.DateSpecific,
                        types.TimeEntered,
                        types.DateEntered,
                        types.TimeSun,
                        types.TimeMoon,
                        types.DayOfMonth,
                        'flow',
                        'global',
                        'str',
                        'num',
                        'bool',
                        'json',
                        'bin',
                        'env',
                        'jsonata',
                        types.SunCalc,
                        types.MoonCalc
                    ],
                    onChange: (_type, _value) => {
                        $('#node-input-addPayload1').change();
                        if (!$('.time-addPayload1Value').is(':hidden')) {
                            getOutDataData(d => {
                                const $div = $('#node-input-addPayload1-div');
                                const titleOrg = $div.attr('titleOrg');
                                if (d) {
                                    $div.attr('title', d + ' - ' + titleOrg);
                                } else {
                                    $div.attr('title', titleOrg);
                                }
                            }, {
                                config:     $nodeConfig.val(),
                                type:       $('#node-input-addPayload1Value').typedInput('type'),
                                value:      $('#node-input-addPayload1Value').typedInput('value'),
                                format:     $('#node-input-addPayload1Format').val(),
                                offsetType: $('#node-input-addPayload1Offset').typedInput('type'),
                                offset:     $('#node-input-addPayload1Offset').typedInput('value'),
                                multiplier: $('#node-input-addPayload1OffsetMultiplier').val()
                            });
                        }
                    }
                });

                initDaysCheckbox('#time-inject-addPayload1Days', node.addPayload1Days);

                initCombobox(node, $('#node-input-addPayload1Formatsel'), $('#node-input-addPayload1Format'), 'dateOutFormat', 'outputFormats', node.addPayload1Format || 0, 30);

                node.addPayload1OffsetMultiplier = multiplierUpdate(node.addPayload1OffsetMultiplier, 'addPayload1OffsetMultiplier');

                setupTInput(node, {
                    typeProp: 'addPayload1OffsetType',
                    valueProp: 'addPayload1Offset',
                    width: 'calc(100% - 265px)',
                    defaultType: (node.addPayload1Offset === 0 || node.addPayload1Offset === '') ? types.Undefined.value : 'num',
                    defaultValue: 0,
                    types: [types.Undefined, 'num', 'flow', 'global', 'env'],
                    onChange: (_type, _value) => {
                        const type = $('#node-input-addPayload1Offset').typedInput('type');
                        if (type === types.Undefined.value) {
                            $('#node-input-addPayload1OffsetMultiplier').prop('disabled', true);
                        } else {
                            $('#node-input-addPayload1OffsetMultiplier').prop('disabled', false);
                        }
                    }
                }).change();
                // #endregion addPayload1
                // #region addPayload2
                if (node.addPayload2Type === types.MsgPayload.value) {
                    node.addPayload2Type = 'msg';
                    node.addPayload2 = 'payload';
                }
                setupTInput(node, {
                    typeProp: 'addPayload2Type',
                    valueProp: 'addPayload2',
                    width: 'calc(100% - 110px)',
                    defaultType: types.Undefined.value,
                    defaultValue: '',
                    types: [types.Undefined, 'msg', types.MsgTs, types.MsgLc, types.MsgValue, 'flow', 'global'],
                    onChange: (_type, _value) => {
                        const plType = $('#node-input-addPayload2').typedInput('type');
                        if (plType !== types.Undefined.value) {
                            $('.time-addPayload2Value').show();
                            $('.time-addPayload3').show();
                            const plVType = $('#node-input-addPayload2Value').typedInput('type');
                            if (plVType === types.TimeEntered.value ||
                                plVType === types.TimeSun.value ||
                                plVType === types.TimeMoon.value) {
                                $('.time-inject-row-addPayload2Format').show();
                                $('.time-inject-row-addPayload2Offset').show();
                                $('.time-inject-row-addPayload2days').show();
                            } else if (plVType === types.DateSpecific.value ||
                                       plVType === types.DateEntered.value ||
                                       plVType === types.DayOfMonth.value) {
                                $('.time-inject-row-addPayload2Format').show();
                                $('.time-inject-row-addPayload2Offset').show();
                                $('.time-inject-row-addPayload2days').hide();
                            } else {
                                $('.time-inject-row-addPayload2Format').hide();
                                $('.time-inject-row-addPayload2Offset').hide();
                                $('.time-inject-row-addPayload2days').hide();
                            }
                        } else {
                            $('.time-addPayload2Value').hide();
                            $('.time-inject-row-addPayload2Format').hide();
                            $('.time-inject-row-addPayload2Offset').hide();
                            $('.time-inject-row-addPayload2days').hide();
                            $('.time-addPayload3').hide();
                        }

                        $('#node-input-addPayload3').change();
                    }
                });

                setupTInput(node, {
                    typeProp: 'addPayload2ValueType',
                    valueProp: 'addPayload2Value',
                    width: 'calc(100% - 120px)',
                    defaultType: 'date',
                    defaultValue: '',
                    types: [
                        'date',
                        types.DateSpecific,
                        types.TimeEntered,
                        types.TimeSun,
                        types.TimeMoon,
                        types.DayOfMonth,
                        'flow',
                        'global',
                        'str',
                        'num',
                        'bool',
                        'json',
                        'bin',
                        'env',
                        'jsonata',
                        types.SunCalc,
                        types.MoonCalc
                    ],
                    onChange: (_type, _value) => {
                        $('#node-input-addPayload2').change();
                        if (!$('.time-addPayload2Value').is(':hidden')) {
                            getOutDataData(d => {
                                const $div = $('#node-input-addPayload1-div');
                                const titleOrg = $div.attr('titleOrg');
                                if (d) {
                                    $div.attr('title', d + ' - ' + titleOrg);
                                } else {
                                    $div.attr('title', titleOrg);
                                }
                            }, {
                                config:     $nodeConfig.val(),
                                type:       $('#node-input-addPayload2Value').typedInput('type'),
                                value:      $('#node-input-addPayload2Value').typedInput('value'),
                                format:     $('#node-input-addPayload2Format').val(),
                                offsetType: $('#node-input-addPayload2Offset').typedInput('type'),
                                offset:     $('#node-input-addPayload2Offset').typedInput('value'),
                                multiplier: $('#node-input-addPayload2OffsetMultiplier').val()
                            });
                        }
                    }
                });

                initDaysCheckbox('#time-inject-addPayload2Days', node.addPayload2Days);

                initCombobox(node, $('#node-input-addPayload2Formatsel'), $('#node-input-addPayload2Format'), 'dateOutFormat', 'outputFormats', node.addPayload2Format || 0, 30);

                node.addPayload2OffsetMultiplier = multiplierUpdate(node.addPayload2OffsetMultiplier, 'addPayload2OffsetMultiplier');
                setupTInput(node, {
                    typeProp: 'addPayload2OffsetType',
                    valueProp: 'addPayload2Offset',
                    width: 'calc(100% - 265px)',
                    defaultType: (node.addPayload2Offset === 0 || node.addPayload2Offset === '') ? types.Undefined.value : 'num',
                    defaultValue: 0,
                    types: [types.Undefined, 'num', 'flow', 'global', 'env'],
                    onChange: (_type, _value) => {
                        const type = $('#node-input-addPayload2Offset').typedInput('type');
                        if (type === types.Undefined.value) {
                            $('#node-input-addPayload2OffsetMultiplier').prop('disabled', true);
                        } else {
                            $('#node-input-addPayload2OffsetMultiplier').prop('disabled', false);
                        }
                    }
                }).change();
                // #endregion addPayload2
                // #region addPayload3
                if (node.addPayload3Type === types.MsgPayload.value) {
                    node.addPayload3Type = 'msg';
                    node.addPayload3 = 'payload';
                }
                setupTInput(node, {
                    typeProp: 'addPayload3Type',
                    valueProp: 'addPayload3',
                    width: 'calc(100% - 110px)',
                    defaultType: types.Undefined.value,
                    defaultValue: '',
                    types: [types.Undefined, 'msg', types.MsgTs, types.MsgLc, types.MsgValue, 'flow', 'global'],
                    onChange: (_type, _value) => {
                        const plType = $('#node-input-addPayload3').typedInput('type');
                        if (plType !== types.Undefined.value) {
                            $('.time-addPayload3Value').show();
                            const plVType = $('#node-input-addPayload3Value').typedInput('type');
                            if (plVType === types.TimeEntered.value ||
                                plVType === types.TimeSun.value ||
                                plVType === types.TimeMoon.value) {
                                $('.time-inject-row-addPayload3Format').show();
                                $('.time-inject-row-addPayload3Offset').show();
                                $('.time-inject-row-addPayload3days').show();
                            } else if (plVType === types.DateSpecific.value ||
                                       plVType === types.DateEntered.value ||
                                       plVType === types.DayOfMonth.value) {
                                $('.time-inject-row-addPayload3Format').show();
                                $('.time-inject-row-addPayload3Offset').show();
                                $('.time-inject-row-addPayload3days').hide();
                            } else {
                                $('.time-inject-row-addPayload3Format').hide();
                                $('.time-inject-row-addPayload3Offset').hide();
                                $('.time-inject-row-addPayload3days').hide();
                            }
                        } else {
                            $('.time-addPayload3Value').hide();
                            $('.time-inject-row-addPayload3Format').hide();
                            $('.time-inject-row-addPayload3Offset').hide();
                            $('.time-inject-row-addPayload3days').hide();
                        }
                    }
                });

                setupTInput(node, {
                    typeProp: 'addPayload3ValueType',
                    valueProp: 'addPayload3Value',
                    width: 'calc(100% - 120px)',
                    defaultType: 'date',
                    defaultValue: '',
                    types: [
                        'date',
                        types.DateSpecific,
                        types.TimeEntered,
                        types.TimeSun,
                        types.TimeMoon,
                        types.DayOfMonth,
                        'flow',
                        'global',
                        'str',
                        'num',
                        'bool',
                        'json',
                        'bin',
                        'env',
                        'jsonata',
                        types.SunCalc,
                        types.MoonCalc
                    ],
                    onChange: (_type, _value) => {
                        $('#node-input-addPayload3').change();
                        if (!$('.time-addPayload3Value').is(':hidden')) {
                            getOutDataData(d => {
                                const $div = $('#node-input-addPayload1-div');
                                const titleOrg = $div.attr('titleOrg');
                                if (d) {
                                    $div.attr('title', d + ' - ' + titleOrg);
                                } else {
                                    $div.attr('title', titleOrg);
                                }
                            }, {
                                config:     $nodeConfig.val(),
                                type:       $('#node-input-addPayload3Value').typedInput('type'),
                                value:      $('#node-input-addPayload3Value').typedInput('value'),
                                format:     $('#node-input-addPayload3Format').val(),
                                offsetType: $('#node-input-addPayload3Offset').typedInput('type'),
                                offset:     $('#node-input-addPayload3Offset').typedInput('value'),
                                multiplier: $('#node-input-addPayload3OffsetMultiplier').val()
                            });
                        }
                    }
                });

                initDaysCheckbox('#time-inject-addPayload3Days', node.addPayload3Days);

                initCombobox(node, $('#node-input-addPayload3Formatsel'), $('#node-input-addPayload3Format'), 'dateOutFormat', 'outputFormats', node.addPayload3Format || 0, 30);

                node.addPayload3OffsetMultiplier = multiplierUpdate(node.addPayload3OffsetMultiplier, 'addPayload3OffsetMultiplier');
                setupTInput(node, {
                    typeProp: 'addPayload3OffsetType',
                    valueProp: 'addPayload3Offset',
                    width: 'calc(100% - 265px)',
                    defaultType: (node.addPayload3Offset === 0 || node.addPayload3Offset === '') ? types.Undefined.value : 'num',
                    defaultValue: 0,
                    types: [types.Undefined, 'num', 'flow', 'global', 'env'],
                    onChange: (_type, _value) => {
                        const type = $('#node-input-addPayload3Offset').typedInput('type');
                        if (type === types.Undefined.value) {
                            $('#node-input-addPayload3OffsetMultiplier').prop('disabled', true);
                        } else {
                            $('#node-input-addPayload3OffsetMultiplier').prop('disabled', false);
                        }
                    }
                }).change();
                // #endregion addPayload3
                // #region onceDelay
                $('#node-input-once').change(() => {
                    $('#node-input-onceDelay').attr('disabled', !$('#node-input-once').prop('checked'));
                });
                // #endregion onceDelay
                $payload.change();
                $time.change(); // also property change
                $timeAlt.change();
                $addPayload1.change(); // addPayload2 + addPayload3
            }; // setup

            $.getScript('sun-position/js/htmlglobal.js')
                .done((_data, _textStatus, _jqxhr) => {
                    try {
                        setup(node);
                    } catch (err) {
                        console.log("failed to setup editor"); // eslint-disable-line
                        console.log(err); // eslint-disable-line
                        console.log(err.stack); // eslint-disable-line
                    }
                })
                .fail((jqxhr, settings, exception) => {
                    console.log("failed to load htmlglobal.js"); // eslint-disable-line
                    console.log(exception); // eslint-disable-line
                    console.log(exception.stack); // eslint-disable-line
                });
        },
        oneditsave() {
            function getDaysStr(value) {
                const days = value.map((_, el) => { return $(el).val(); }).get();
                if (days.length === 0) { return ''; }
                if (days.length === 7) { return '*'; }
                return days.join(',');
            }
            // this.payloadType = $("#node-input-payload").typedInput("type");
            // this.timeType = $("#node-input-time").typedInput("type");
            this.timeDays = getDaysStr($('#time-inject-timeDays input[type=checkbox]:checked'));
            // this.propertyType = $("#node-input-property").typedInput("type");
            // this.timeAltType = $("#node-input-timeAlt").typedInput("type");
            this.timeAltDays = getDaysStr($('#time-inject-timeAltDays input[type=checkbox]:checked'));

            // this.addPayload1Type = $("#node-input-addPayload1").typedInput("type");
            // this.addPayload1ValueType = $("#node-input-addPayload1Value").typedInput("type");
            this.addPayload1Days = getDaysStr($('#time-inject-addPayload1Days input[type=checkbox]:checked'));
            if (Number($('#node-input-addPayload1Formatsel').val()) !== 99) {
                $('#node-input-addPayload1Format').val($('#node-input-addPayload1Formatsel').val());
                this.addPayload1Format = $('#node-input-addPayload1Formatsel').val();
            }

            // this.addPayload2Type = $("#node-input-addPayload2").typedInput("type");
            // this.addPayload2ValueType = $("#node-input-addPayload2Value").typedInput("type");
            this.addPayload2Days = getDaysStr($('#time-inject-addPayload2Days input[type=checkbox]:checked'));
            if (Number($('#node-input-addPayload2Formatsel').val()) !== 99) {
                $('#node-input-addPayload2Format').val($('#node-input-addPayload2Formatsel').val());
                this.addPayload2Format = $('#node-input-addPayload2Formatsel').val();
            }

            // this.addPayload3Type = $("#node-input-addPayload3").typedInput("type");
            // this.addPayload3ValueType = $("#node-input-addPayload3Value").typedInput("type");
            this.addPayload3Days = getDaysStr($('#time-inject-addPayload3Days input[type=checkbox]:checked'));
            if (Number($('#node-input-addPayload3Formatsel').val()) !== 99) {
                $('#node-input-addPayload3Format').val($('#node-input-addPayload3Formatsel').val());
                this.addPayload3Format = $('#node-input-addPayload3Formatsel').val();
            }
        },
        button: {
            enabled: function() {
                return !this.changed;
            },
            onclick: function() {
                if (this.changed) {
                    return RED.notify(RED._('node-red:notification.warning', { message: RED._('node-red:notification.warnings.undeployedChanges') }), 'warning');
                }

                let payload = this.payload;
                if ((this.payloadType === 'flow') ||
                    (this.payloadType === 'global')) {
                    const key = RED.utils.parseContextKey(payload);
                    payload = this.payloadType + '.' + key.key;
                }

                if (this.payloadType === 'str' || this.payloadType === 'string') { payload = '"' + this.payload + '"'; }
                let label = this._def.label.call(this);
                label = label.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
                const node = this;
                $.ajax({
                    url: 'time-inject/' + this.id,
                    type: 'POST',
                    success: function(_resp) {
                        RED.notify(node._('node-red:inject.success',{label:label}),{type:'success',id:'inject'});
                    },
                    error: function(jqXHR, textStatus, _errorThrown) {
                        if (jqXHR.status === 404) {
                            RED.notify(node._('node-red:common.notification.error',{message:node._('node-red:common.notification.errors.not-deployed')}),'error');
                        } else if (jqXHR.status === 500) {
                            RED.notify(node._('node-red:common.notification.error',{message:node._('node-red:inject.errors.failed')}),'error');
                        } else if (jqXHR.status === 0) {
                            RED.notify(node._('node-red:common.notification.error',{message:node._('node-red:common.notification.errors.no-response')}),'error');
                        } else {
                            RED.notify(node._('node-red:common.notification.error',{message:node._('node-red:common.notification.errors.unexpected',{status:jqXHR.status,message:textStatus})}),'error');
                        }
                    }
                });
            }
        }
    });</script>